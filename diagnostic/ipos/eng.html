<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IPOS Assessment | PalliCalc</title>
    
    <link rel="stylesheet" href="../diagnostic.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script src="../diagnostic.js"></script>
</head>
<body>

    <div class="main-container">
        
        <div class="header header-ipos">
            <div id="inst-header-container" class="inst-header-container">
                <img id="inst-logo-img" class="inst-logo" src="" alt="Logo" style="display:none;">
                <div class="inst-info"><h3 id="inst-name-display"></h3><p id="inst-contact-display"></p></div>
            </div>
            <h1>IPOS Assessment</h1>
            <p>Integrated Palliative care Outcome Scale</p>
        </div>

        <div id="blank-qr-header">
            <div style="display:flex; align-items:center; justify-content:center; gap:20px; border: 2px dashed #ccc; padding: 15px; border-radius: 8px;">
                <div id="blank-qrcode"></div>
                <div style="text-align:left;">
                    <h4 style="margin:0; color:#0061f2;">Scan to Start</h4>
                    <small>Scan this code to fill the form on your phone.</small>
                </div>
            </div>
        </div>

        <div class="nav-bar no-print">
            <a href="../../diagnostic.html" class="nav-link" id="backLink"><i class="bi bi-arrow-left"></i> Back</a>
            <div class="nav-link" style="color:#6c757d; cursor:default;"><i class="bi bi-calendar-event"></i> <span id="dateDisplay"></span></div>
        </div>

        <form id="iposForm">
            
            <div class="print-page-1">
                
                <div class="question-card">
                    <label class="q-label">Q1. Main concerns (Past 3 days):</label>
                    <textarea class="form-control" id="q1_input" rows="3" style="width:100%; border:1px solid #ced4da; border-radius:6px; padding:10px; font-size:16px;" placeholder="List concerns..."></textarea>
                </div>

                <div class="question-card">
                    <label class="q-label">Q2. How have these symptoms affected you?</label>
                    
                    <label class="sub-label">Pain</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="pain" value="0" id="pain_0"><label for="pain_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="pain" value="1" id="pain_1"><label for="pain_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="pain" value="2" id="pain_2"><label for="pain_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="pain" value="3" id="pain_3"><label for="pain_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="pain" value="4" id="pain_4"><label for="pain_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Shortness of Breath</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="sob" value="0" id="sob_0"><label for="sob_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="sob" value="1" id="sob_1"><label for="sob_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="sob" value="2" id="sob_2"><label for="sob_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="sob" value="3" id="sob_3"><label for="sob_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="sob" value="4" id="sob_4"><label for="sob_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Weakness</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="weak" value="0" id="weak_0"><label for="weak_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="weak" value="1" id="weak_1"><label for="weak_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="weak" value="2" id="weak_2"><label for="weak_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="weak" value="3" id="weak_3"><label for="weak_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="weak" value="4" id="weak_4"><label for="weak_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Nausea</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="nau" value="0" id="nau_0"><label for="nau_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="nau" value="1" id="nau_1"><label for="nau_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="nau" value="2" id="nau_2"><label for="nau_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="nau" value="3" id="nau_3"><label for="nau_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="nau" value="4" id="nau_4"><label for="nau_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Vomiting</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="vom" value="0" id="vom_0"><label for="vom_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="vom" value="1" id="vom_1"><label for="vom_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="vom" value="2" id="vom_2"><label for="vom_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="vom" value="3" id="vom_3"><label for="vom_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="vom" value="4" id="vom_4"><label for="vom_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Poor Appetite</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="app" value="0" id="app_0"><label for="app_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="app" value="1" id="app_1"><label for="app_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="app" value="2" id="app_2"><label for="app_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="app" value="3" id="app_3"><label for="app_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="app" value="4" id="app_4"><label for="app_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Constipation</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="con" value="0" id="con_0"><label for="con_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="con" value="1" id="con_1"><label for="con_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="con" value="2" id="con_2"><label for="con_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="con" value="3" id="con_3"><label for="con_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="con" value="4" id="con_4"><label for="con_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Sore/Dry Mouth</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="mou" value="0" id="mou_0"><label for="mou_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="mou" value="1" id="mou_1"><label for="mou_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="mou" value="2" id="mou_2"><label for="mou_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="mou" value="3" id="mou_3"><label for="mou_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="mou" value="4" id="mou_4"><label for="mou_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Drowsiness</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="dro" value="0" id="dro_0"><label for="dro_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="dro" value="1" id="dro_1"><label for="dro_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="dro" value="2" id="dro_2"><label for="dro_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="dro" value="3" id="dro_3"><label for="dro_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="dro" value="4" id="dro_4"><label for="dro_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Poor Mobility</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="mob" value="0" id="mob_0"><label for="mob_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="mob" value="1" id="mob_1"><label for="mob_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="mob" value="2" id="mob_2"><label for="mob_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="mob" value="3" id="mob_3"><label for="mob_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="mob" value="4" id="mob_4"><label for="mob_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <div class="mt-4 pt-3 border-top" style="margin-top:20px; border-top:1px solid #eee;">
                        <label class="sub-label text-primary">Other Symptoms:</label>
                        <input type="text" id="other_sym_label" class="form-control mb-2" maxlength="20" placeholder="e.g. Itchiness" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        <div class="scale-container">
                            <div class="scale-opt"><input type="radio" name="other_sym_val" value="0" id="oth_0"><label for="oth_0">0</label></div>
                            <div class="scale-opt"><input type="radio" name="other_sym_val" value="1" id="oth_1"><label for="oth_1">1</label></div>
                            <div class="scale-opt"><input type="radio" name="other_sym_val" value="2" id="oth_2"><label for="oth_2">2</label></div>
                            <div class="scale-opt"><input type="radio" name="other_sym_val" value="3" id="oth_3"><label for="oth_3">3</label></div>
                            <div class="scale-opt"><input type="radio" name="other_sym_val" value="4" id="oth_4"><label for="oth_4">4</label></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page-break"></div>

            <div class="print-page-2">
                <div class="question-card">
                    <label class="q-label">Q3. Feeling anxious/worried about illness?</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="anxious" value="0" id="anx_0"><label for="anx_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="anxious" value="1" id="anx_1"><label for="anx_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="anxious" value="2" id="anx_2"><label for="anx_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="anxious" value="3" id="anx_3"><label for="anx_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="anxious" value="4" id="anx_4"><label for="anx_4">4<div class="scale-desc">Always</div></label></div>
                    </div>
                </div>

                <div class="question-card">
                    <label class="q-label">Q4. Family/friends anxious about you?</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="family" value="0" id="fam_0"><label for="fam_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="family" value="1" id="fam_1"><label for="fam_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="family" value="2" id="fam_2"><label for="fam_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="family" value="3" id="fam_3"><label for="fam_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="family" value="4" id="fam_4"><label for="fam_4">4<div class="scale-desc">Always</div></label></div>
                    </div>
                </div>

                <div class="question-card">
                    <label class="q-label">Q5. Feeling depressed?</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="depressed" value="0" id="dep_0"><label for="dep_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="depressed" value="1" id="dep_1"><label for="dep_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="depressed" value="2" id="dep_2"><label for="dep_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="depressed" value="3" id="dep_3"><label for="dep_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="depressed" value="4" id="dep_4"><label for="dep_4">4<div class="scale-desc">Always</div></label></div>
                    </div>
                </div>

                <div class="question-card">
                    <label class="q-label">Q6. Have you felt at peace?</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="peace" value="4" id="pea_0"><label for="pea_0">4<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="peace" value="3" id="pea_1"><label for="pea_1">3</label></div>
                        <div class="scale-opt"><input type="radio" name="peace" value="2" id="pea_2"><label for="pea_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="peace" value="1" id="pea_3"><label for="pea_3">1</label></div>
                        <div class="scale-opt"><input type="radio" name="peace" value="0" id="pea_4"><label for="pea_4">0<div class="scale-desc">Always</div></label></div>
                    </div>
                </div>

                <div class="question-card">
                    <label class="q-label">Q7. Able to share feelings?</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="share" value="4" id="sha_0"><label for="sha_0">4<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="share" value="3" id="sha_1"><label for="sha_1">3</label></div>
                        <div class="scale-opt"><input type="radio" name="share" value="2" id="sha_2"><label for="sha_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="share" value="1" id="sha_3"><label for="sha_3">1</label></div>
                        <div class="scale-opt"><input type="radio" name="share" value="0" id="sha_4"><label for="sha_4">0<div class="scale-desc">Always</div></label></div>
                    </div>
                </div>

                <div class="question-card">
                    <label class="q-label">Q8. Had enough information?</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="info" value="4" id="inf_0"><label for="inf_0">4<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="info" value="3" id="inf_1"><label for="inf_1">3</label></div>
                        <div class="scale-opt"><input type="radio" name="info" value="2" id="inf_2"><label for="inf_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="info" value="1" id="inf_3"><label for="inf_3">1</label></div>
                        <div class="scale-opt"><input type="radio" name="info" value="0" id="inf_4"><label for="inf_4">0<div class="scale-desc">Always</div></label></div>
                    </div>
                </div>

                <div class="question-card">
                    <label class="q-label">Q9. Practical problems addressed?</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="practical" value="4" id="pra_0"><label for="pra_0">4<div class="scale-desc">Not addressed</div></label></div>
                        <div class="scale-opt"><input type="radio" name="practical" value="3" id="pra_1"><label for="pra_1">3</label></div>
                        <div class="scale-opt"><input type="radio" name="practical" value="2" id="pra_2"><label for="pra_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="practical" value="1" id="pra_3"><label for="pra_3">1</label></div>
                        <div class="scale-opt"><input type="radio" name="practical" value="0" id="pra_4"><label for="pra_4">0<div class="scale-desc">Addressed</div></label></div>
                    </div>
                </div>

                <div class="question-card">
                    <label class="q-label">Q10. How did you complete this?</label>
                    <select id="completion_mode" class="form-select" style="font-size:14px; padding:8px; width:100%; border:1px solid #ced4da; border-radius:6px;">
                        <option value="0">On my own</option>
                        <option value="1">With help from a friend or relative</option>
                        <option value="2">With help from a member of staff</option>
                    </select>
                </div>
            </div>

            <div class="score-box no-print">
                <div><div class="score-title">Total IPOS Score</div><small style="opacity:0.7">Higher = More Distress</small></div>
                <div class="score-val" id="total-score-display">0</div>
            </div>

            <div id="qr-section">
                <div class="alert alert-success" style="background:#d4edda; color:#155724; padding:8px; border-radius:6px; margin-bottom:8px; font-size:12px;">
                    <i class="bi bi-check-circle-fill"></i> <strong>Result Ready!</strong>
                    <p style="margin:0; font-size:13px;">Show this QR to your doctor.</p>
                </div>
                <div id="qrcode-container" style="background:white; padding:8px; border-radius:8px; display:inline-block;">
                    <div id="qrcode"></div>
                    <div style="font-size:9px; color:#999; margin-top:4px;">IPOS Secure Payload</div>
                </div>
            </div>

            <div class="action-buttons no-print" style="margin-top:20px; display:flex; gap:8px; flex-direction:column;">
                <button type="button" class="btn btn-buccal" onclick="generateQR()" style="width:100%;">
                    <i class="bi bi-qr-code-scan"></i> Generate Result QR
                </button>
                <button type="button" class="btn btn-pdf" onclick="printBlankForm()" style="width:100%;">
                    <i class="bi bi-printer"></i> Print Blank Form
                </button>
            </div>
        </form>

    </div>

    <footer class="legal-footer">
        <div style="max-width:480px; margin:0 auto; padding:0 20px;">
            <p class="copyright-text">&copy; 2026 Alivioscript Solutions</p>
            <div class="author-info">
                <span class="author-name">Author: Alison Chai</span>
                <span class="author-creds">RPh (M'sia):&nbsp;9093 &nbsp;|&nbsp; GPhC (UK):&nbsp;2077838</span>
            </div>
            <p class="legal-warning">Clinical Tool. For Professional Use Only.</p>
            <div id="footer-inst-name" style="margin-top:8px; font-weight:bold; color:#0061f2; font-size:11px;"></div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString();
            document.getElementById('iposForm').addEventListener('change', calculateTotalScore);

            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref');
            if (ref) {
                document.getElementById('backLink').href = `../../diagnostic.html?ref=${ref}`;
                await loadInstitutionData(ref);
            }
            
            // Create "Blank Form" QR Code (points to this page)
            new QRCode(document.getElementById("blank-qrcode"), { 
                text: window.location.href, 
                width: 90, 
                height: 90 
            });
        });

        // --- NATIVE PRINT FUNCTION ---
        function printBlankForm() {
            window.print(); 
        }
    </script>
</body>
</html>