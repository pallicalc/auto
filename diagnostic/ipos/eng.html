<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IPOS Assessment | PalliCalc</title>
    
    <link rel="stylesheet" href="../diagnostic.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="../diagnostic.js"></script>

    <style>
        /* LAYOUT & OVERRIDES */
        body { display: flex; flex-direction: column; min-height: 100vh; background-color: #f0f2f5; margin: 0; }
        .main-container { flex: 1; width: 100%; max-width: 800px; margin: 20px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }

        /* HEADER */
        .header-ipos { 
            background: linear-gradient(135deg, #0061f2 0%, #00c6f7 100%) !important; 
            margin: -30px -30px 30px -30px; border-radius: 12px 12px 0 0; padding: 30px; color: white;
            box-shadow: 0 4px 12px rgba(0, 97, 242, 0.2);
        }
        
        /* QUESTIONS */
        .question-card { background: #fff; border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid #eef2f6; break-inside: avoid; }
        .q-label { font-weight: 700; color: #2c3e50; margin-bottom: 12px; display: block; font-size: 15px; }
        .sub-label { display:block; font-weight:600; font-size:14px; margin-bottom:8px; color:#495057; }
        
        /* SCALES */
        .scale-container { display: flex; justify-content: space-between; gap: 4px; margin-top: 10px; margin-bottom: 15px; }
        .scale-opt { flex: 1; text-align: center; position: relative; }
        .scale-opt input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2; }
        .scale-opt label {
            display: flex; flex-direction: column; justify-content: center; height: 50px;
            background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px;
            color: #6c757d; font-weight: 700; transition: all 0.2s; font-size: 16px; line-height: 1.1;
        }
        .scale-opt input:checked + label { background: #e3f2fd; border-color: #0061f2; color: #0061f2; box-shadow: 0 2px 5px rgba(0,97,242,0.15); }
        .scale-desc { font-size: 10px; font-weight: 400; margin-top: 2px; }

        /* PRINT / PDF MODE */
        .blank-mode .scale-opt label { background: white !important; border: 1px solid #333 !important; color: #ccc !important; }
        
        /* Used during PDF generation to clean up UI */
        .pdf-clean-mode .main-container { box-shadow: none; margin: 0; padding: 0; width: 100%; max-width: 100%; }
        .pdf-clean-mode body { background: white; }
        
        @media print { body { background: white; } .no-print, .legal-footer { display: none !important; } .main-container { box-shadow: none; margin: 0; padding: 0; max-width: 100%; } }
        
        /* SCORE BOX */
        .score-box { background: #2c3e50; color: white; padding: 20px; border-radius: 12px; margin-top: 30px; display: flex; justify-content: space-between; align-items: center; }
        .score-val { font-size: 28px; font-weight: 800; color: #00c6f7; }
        
        /* FOOTER */
        .legal-footer { width: 100%; margin-top: 40px; padding: 24px 0; border-top: 1px solid #dee2e6; text-align: center; background-color: #f8f9fa; color: #6c757d; }
    </style>
</head>
<body>

    <div id="pdf-loading" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; flex-direction:column; justify-content:center; align-items:center;">
        <div style="display:inline-block; width:3rem; height:3rem; border:4px solid #f3f3f3; border-top:4px solid #0061f2; border-radius:50%; animation:spin 1s linear infinite;"></div>
        <p style="margin-top:15px; font-weight:bold; color:#555">Generating PDF...</p>
        <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
    </div>

    <div class="main-container" id="main-content-area">
        
        <div class="header header-ipos" id="pdf-header">
            <div id="inst-header-container" class="inst-header-container">
                <img id="inst-logo-img" class="inst-logo" src="" alt="Logo" style="display:none;">
                <div class="inst-info"><h3 id="inst-name-display"></h3><p id="inst-contact-display"></p></div>
            </div>
            <h1>IPOS Assessment</h1>
            <p>Integrated Palliative care Outcome Scale</p>
        </div>

        <div id="blank-qr-header" style="display:none; text-align:center; margin-bottom:20px; border-bottom:2px dashed #ccc; padding-bottom:15px;">
            <div style="display:flex; align-items:center; justify-content:center; gap:20px;">
                <div id="blank-qrcode"></div>
                <div style="text-align:left;"><h4 style="margin:0; color:#0061f2;">Scan to Fill Digitally</h4><small>Use your camera to open this form.</small></div>
            </div>
        </div>

        <div class="nav-bar no-print">
            <a href="../../diagnostic.html" class="nav-link" id="backLink"><i class="bi bi-arrow-left"></i> Back</a>
            <div class="nav-link" style="color:#6c757d; cursor:default;"><i class="bi bi-calendar-event"></i> <span id="dateDisplay"></span></div>
        </div>

        <form id="iposForm">
            <div id="pdf-page-1">
                <div class="question-card">
                    <label class="q-label">Q1. What have been your main problems or concerns over the past 3 days?</label>
                    <textarea class="form-control" id="q1_input" rows="3" style="width:100%; border:1px solid #ced4da; border-radius:6px; padding:10px; font-size:16px;" placeholder="List concerns..."></textarea>
                </div>

                <div class="question-card">
                    <label class="q-label">Q2. How have these symptoms affected you?</label>
                    
                    <label class="sub-label">Pain</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="pain" value="0" id="pain_0"><label for="pain_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="pain" value="1" id="pain_1"><label for="pain_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="pain" value="2" id="pain_2"><label for="pain_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="pain" value="3" id="pain_3"><label for="pain_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="pain" value="4" id="pain_4"><label for="pain_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Shortness of Breath</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="sob" value="0" id="sob_0"><label for="sob_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="sob" value="1" id="sob_1"><label for="sob_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="sob" value="2" id="sob_2"><label for="sob_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="sob" value="3" id="sob_3"><label for="sob_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="sob" value="4" id="sob_4"><label for="sob_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Weakness</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="weak" value="0" id="weak_0"><label for="weak_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="weak" value="1" id="weak_1"><label for="weak_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="weak" value="2" id="weak_2"><label for="weak_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="weak" value="3" id="weak_3"><label for="weak_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="weak" value="4" id="weak_4"><label for="weak_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Nausea</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="nau" value="0" id="nau_0"><label for="nau_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="nau" value="1" id="nau_1"><label for="nau_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="nau" value="2" id="nau_2"><label for="nau_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="nau" value="3" id="nau_3"><label for="nau_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="nau" value="4" id="nau_4"><label for="nau_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Vomiting</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="vom" value="0" id="vom_0"><label for="vom_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="vom" value="1" id="vom_1"><label for="vom_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="vom" value="2" id="vom_2"><label for="vom_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="vom" value="3" id="vom_3"><label for="vom_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="vom" value="4" id="vom_4"><label for="vom_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Poor Appetite</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="app" value="0" id="app_0"><label for="app_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="app" value="1" id="app_1"><label for="app_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="app" value="2" id="app_2"><label for="app_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="app" value="3" id="app_3"><label for="app_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="app" value="4" id="app_4"><label for="app_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Constipation</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="con" value="0" id="con_0"><label for="con_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="con" value="1" id="con_1"><label for="con_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="con" value="2" id="con_2"><label for="con_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="con" value="3" id="con_3"><label for="con_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="con" value="4" id="con_4"><label for="con_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Sore/Dry Mouth</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="mou" value="0" id="mou_0"><label for="mou_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="mou" value="1" id="mou_1"><label for="mou_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="mou" value="2" id="mou_2"><label for="mou_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="mou" value="3" id="mou_3"><label for="mou_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="mou" value="4" id="mou_4"><label for="mou_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Drowsiness</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="dro" value="0" id="dro_0"><label for="dro_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="dro" value="1" id="dro_1"><label for="dro_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="dro" value="2" id="dro_2"><label for="dro_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="dro" value="3" id="dro_3"><label for="dro_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="dro" value="4" id="dro_4"><label for="dro_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <label class="sub-label">Poor Mobility</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="mob" value="0" id="mob_0"><label for="mob_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="mob" value="1" id="mob_1"><label for="mob_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="mob" value="2" id="mob_2"><label for="mob_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="mob" value="3" id="mob_3"><label for="mob_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="mob" value="4" id="mob_4"><label for="mob_4">4<div class="scale-desc">Over- whelm.</div></label></div>
                    </div>

                    <div class="mt-4 pt-3 border-top" style="margin-top:20px; border-top:1px solid #eee;">
                        <label class="sub-label text-primary">Other Symptoms:</label>
                        <input type="text" id="other_sym_label" class="form-control mb-2" maxlength="20" placeholder="e.g. Itchiness" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        <div class="scale-container">
                            <div class="scale-opt"><input type="radio" name="other_sym_val" value="0" id="oth_0"><label for="oth_0">0</label></div>
                            <div class="scale-opt"><input type="radio" name="other_sym_val" value="1" id="oth_1"><label for="oth_1">1</label></div>
                            <div class="scale-opt"><input type="radio" name="other_sym_val" value="2" id="oth_2"><label for="oth_2">2</label></div>
                            <div class="scale-opt"><input type="radio" name="other_sym_val" value="3" id="oth_3"><label for="oth_3">3</label></div>
                            <div class="scale-opt"><input type="radio" name="other_sym_val" value="4" id="oth_4"><label for="oth_4">4</label></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pdf-page-2">
                <div class="question-card">
                    <label class="q-label">Q3. Have you been feeling anxious or worried about your illness or treatment?</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="anxious" value="0" id="anx_0"><label for="anx_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="anxious" value="1" id="anx_1"><label for="anx_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="anxious" value="2" id="anx_2"><label for="anx_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="anxious" value="3" id="anx_3"><label for="anx_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="anxious" value="4" id="anx_4"><label for="anx_4">4<div class="scale-desc">Always</div></label></div>
                    </div>
                </div>

                <div class="question-card">
                    <label class="q-label">Q4. Have any of your family or friends been anxious or worried about you?</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="family" value="0" id="fam_0"><label for="fam_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="family" value="1" id="fam_1"><label for="fam_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="family" value="2" id="fam_2"><label for="fam_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="family" value="3" id="fam_3"><label for="fam_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="family" value="4" id="fam_4"><label for="fam_4">4<div class="scale-desc">Always</div></label></div>
                    </div>
                </div>

                <div class="question-card">
                    <label class="q-label">Q5. Have you been feeling depressed?</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="depressed" value="0" id="dep_0"><label for="dep_0">0<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="depressed" value="1" id="dep_1"><label for="dep_1">1</label></div>
                        <div class="scale-opt"><input type="radio" name="depressed" value="2" id="dep_2"><label for="dep_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="depressed" value="3" id="dep_3"><label for="dep_3">3</label></div>
                        <div class="scale-opt"><input type="radio" name="depressed" value="4" id="dep_4"><label for="dep_4">4<div class="scale-desc">Always</div></label></div>
                    </div>
                </div>

                <div class="question-card">
                    <label class="q-label">Q6. Have you felt at peace?</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="peace" value="4" id="pea_0"><label for="pea_0">4<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="peace" value="3" id="pea_1"><label for="pea_1">3</label></div>
                        <div class="scale-opt"><input type="radio" name="peace" value="2" id="pea_2"><label for="pea_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="peace" value="1" id="pea_3"><label for="pea_3">1</label></div>
                        <div class="scale-opt"><input type="radio" name="peace" value="0" id="pea_4"><label for="pea_4">0<div class="scale-desc">Always</div></label></div>
                    </div>
                </div>

                <div class="question-card">
                    <label class="q-label">Q7. Have you been able to share how you are feeling with your family or friends?</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="share" value="4" id="sha_0"><label for="sha_0">4<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="share" value="3" id="sha_1"><label for="sha_1">3</label></div>
                        <div class="scale-opt"><input type="radio" name="share" value="2" id="sha_2"><label for="sha_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="share" value="1" id="sha_3"><label for="sha_3">1</label></div>
                        <div class="scale-opt"><input type="radio" name="share" value="0" id="sha_4"><label for="sha_4">0<div class="scale-desc">Always</div></label></div>
                    </div>
                </div>

                <div class="question-card">
                    <label class="q-label">Q8. Have you had as much information as you wanted?</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="info" value="4" id="inf_0"><label for="inf_0">4<div class="scale-desc">Not at all</div></label></div>
                        <div class="scale-opt"><input type="radio" name="info" value="3" id="inf_1"><label for="inf_1">3</label></div>
                        <div class="scale-opt"><input type="radio" name="info" value="2" id="inf_2"><label for="inf_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="info" value="1" id="inf_3"><label for="inf_3">1</label></div>
                        <div class="scale-opt"><input type="radio" name="info" value="0" id="inf_4"><label for="inf_4">0<div class="scale-desc">Always</div></label></div>
                    </div>
                </div>

                <div class="question-card">
                    <label class="q-label">Q9. Have any practical problems resulting from your illness been addressed?</label>
                    <div class="scale-container">
                        <div class="scale-opt"><input type="radio" name="practical" value="4" id="pra_0"><label for="pra_0">4<div class="scale-desc">Not addressed</div></label></div>
                        <div class="scale-opt"><input type="radio" name="practical" value="3" id="pra_1"><label for="pra_1">3</label></div>
                        <div class="scale-opt"><input type="radio" name="practical" value="2" id="pra_2"><label for="pra_2">2</label></div>
                        <div class="scale-opt"><input type="radio" name="practical" value="1" id="pra_3"><label for="pra_3">1</label></div>
                        <div class="scale-opt"><input type="radio" name="practical" value="0" id="pra_4"><label for="pra_4">0<div class="scale-desc">Addressed</div></label></div>
                    </div>
                </div>

                <div class="question-card">
                    <label class="q-label">Q10. How did you complete this questionnaire?</label>
                    <select id="completion_mode" class="form-select" style="font-size:16px; padding:10px; width:100%; border:1px solid #ced4da; border-radius:6px;">
                        <option value="0">On my own</option>
                        <option value="1">With help from a friend or relative</option>
                        <option value="2">With help from a member of staff</option>
                    </select>
                </div>
                
                <div class="score-box">
                    <div><div class="score-title">Total IPOS Score</div><small style="opacity:0.7">Higher score = Higher distress</small></div>
                    <div class="score-val" id="total-score-display">0</div>
                </div>

                <div id="qr-section" style="display:none; text-align:center; margin-top:30px; border:2px solid #28a745; padding:15px; border-radius:10px;">
                    <div class="alert alert-success" style="background:#d4edda; color:#155724; padding:10px; border-radius:8px; margin-bottom:10px;">
                        <i class="bi bi-check-circle-fill"></i> <strong>Scan to Save</strong>
                    </div>
                    <div id="qrcode-container" style="background:white; padding:10px; border-radius:8px; display:inline-block;">
                        <div id="qrcode"></div>
                        <div style="font-size:10px; color:#999; margin-top:5px;">IPOS Secure Payload</div>
                    </div>
                </div>
            </div>

            <div class="action-buttons no-print" style="margin-top:30px; display:flex; gap:10px; flex-direction:column;">
                <button type="button" class="btn btn-buccal" onclick="generateQR()" style="width:100%; justify-content:center;">
                    <i class="bi bi-qr-code-scan"></i> Generate QR
                </button>
                <button type="button" class="btn btn-pdf" onclick="downloadSmartPDF()" style="width:100%; justify-content:center;">
                    <i class="bi bi-printer"></i> Print / Save as PDF
                </button>
            </div>
        </form>

    </div>

    <footer class="legal-footer no-print" id="pdf-footer">
        <div style="max-width:480px; margin:0 auto; padding:0 20px;">
            <p class="copyright-text">&copy; 2026 Alivioscript Solutions</p>
            <div class="author-info">
                <span class="author-name">Author: Alison Chai</span>
                <span class="author-creds">RPh (M'sia):&nbsp;9093 &nbsp;|&nbsp; GPhC (UK):&nbsp;2077838</span>
            </div>
            <p class="legal-warning">Clinical Tool. For Professional Use Only.</p>
            <div id="footer-inst-name" style="margin-top:8px; font-weight:bold; color:#0061f2; font-size:11px;"></div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString();
            document.getElementById('iposForm').addEventListener('change', calculateTotalScore);

            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref');
            if (ref) {
                document.getElementById('backLink').href = `../../diagnostic.html?ref=${ref}`;
                await loadInstitutionData(ref);
                new QRCode(document.getElementById("blank-qrcode"), { text: window.location.href, width: 64, height: 64 });
            }
        });

        async function downloadSmartPDF() {
            const loading = document.getElementById('pdf-loading');
            loading.style.display = 'flex';
            
            // Clean UI
            document.body.classList.add('pdf-clean-mode');
            window.scrollTo(0, 0);
            await new Promise(r => setTimeout(r, 800));

            const inputs = document.querySelectorAll('input[type="radio"]:checked');
            const q1Text = document.getElementById('q1_input').value.trim();
            const isBlank = (inputs.length === 0 && q1Text === "");

            if (isBlank) {
                document.body.classList.add('blank-mode');
                document.getElementById('blank-qr-header').style.display = 'block';
                document.getElementById('qr-section').style.display = 'none';
                document.getElementById('total-score-display').innerText = ""; 
            } else {
                generateQR();
            }

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 10;
                const contentWidth = pageWidth - (margin * 2);

                const header = document.getElementById('pdf-header');
                const page1Content = document.getElementById('pdf-page-1');
                const page2Content = document.getElementById('pdf-page-2');
                const footer = document.getElementById('pdf-footer');
                
                async function captureAndAdd(element, yOffset) {
                    const canvas = await html2canvas(element, { 
                        scale: 2, 
                        useCORS: true, 
                        backgroundColor: "#ffffff",
                        windowWidth: 800
                    });
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    const imgHeight = (canvas.height * contentWidth) / canvas.width;
                    pdf.addImage(imgData, 'JPEG', margin, yOffset, contentWidth, imgHeight);
                    return imgHeight;
                }

                // --- PAGE 1 ---
                let currentY = margin;
                if (isBlank) {
                    const blankHeader = document.getElementById('blank-qr-header');
                    currentY += await captureAndAdd(blankHeader, currentY) + 5;
                } else {
                    currentY += await captureAndAdd(header, currentY) + 5;
                }
                
                // Add Content
                await captureAndAdd(page1Content, currentY);
                
                // Add Footer at bottom of Page 1
                await captureAndAdd(footer, pageHeight - 30);

                // --- PAGE 2 ---
                pdf.addPage(); 
                currentY = margin;
                await captureAndAdd(page2Content, currentY);
                
                // Add Footer at bottom of Page 2
                await captureAndAdd(footer, pageHeight - 30);

                const fname = isBlank ? "IPOS_Blank_Form.pdf" : `IPOS_Result_${new Date().toISOString().slice(0,10)}.pdf`;
                pdf.save(fname);

            } catch (e) {
                alert("Error: " + e.message);
                console.error(e);
            } finally {
                document.body.classList.remove('pdf-clean-mode');
                document.body.classList.remove('blank-mode');
                document.getElementById('blank-qr-header').style.display = 'none';
                document.getElementById('total-score-display').innerText = calculateTotalScore(); 
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>