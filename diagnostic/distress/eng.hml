<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>心理痛苦温度计 | PalliCalc</title>
    
    <link rel="stylesheet" href="../diagnostic.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="../diagnostic.js"></script>

    <style>
        /* --- THERMOMETER LAYOUT --- */
        .thermo-wrapper {
            display: flex; justify-content: center; align-items: stretch; gap: 20px;
            padding: 10px 0; min-height: 450px;
        }
        .scale-column {
            display: flex; flex-direction: column; justify-content: space-between;
            align-items: flex-end; padding-right: 10px; font-weight: bold; color: #495057;
        }
        .scale-row { display: flex; align-items: center; gap: 10px; height: 35px; }
        .scale-row label { font-size: 18px; cursor: pointer; }
        .scale-row input[type="radio"] { transform: scale(1.5); margin: 0; cursor: pointer; }

        .label-text { font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; margin: 5px 0; }
        .text-extreme { color: #d32f2f; font-weight: 800; }
        .text-none { color: #2e7d32; font-weight: 800; }

        .image-column { display: flex; align-items: center; justify-content: center; }
        .thermo-img { height: 100%; max-height: 480px; width: auto; object-fit: contain; }

        /* --- YES/NO LIST STYLING --- */
        .section-header { 
            background: #f8f9fa; padding: 10px 15px; margin: 20px -20px 10px -20px; 
            font-weight: 700; color: #0061f2; font-size: 14px; text-transform: uppercase; 
            border-left: 4px solid #0061f2;
        }
        .yes-no-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 0; border-bottom: 1px solid #f0f0f0; 
        }
        .yes-no-row:last-child { border-bottom: none; }
        
        .yn-label { 
            font-size: 15px; color: #333; flex: 1; padding-right: 10px; 
            white-space: normal; line-height: 1.3;
        }
        .yn-options { display: flex; gap: 5px; width: 110px; flex-shrink: 0; }

        .yn-btn { flex: 1; position: relative; text-align: center; }
        .yn-btn input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2; left:0; top:0; }
        .yn-btn label {
            display: flex; justify-content: center; align-items: center; height: 35px;
            background: #fff; border: 1px solid #dee2e6; border-radius: 6px;
            color: #6c757d; font-weight: 600; font-size: 13px; transition: all 0.2s;
        }
        .yn-btn input:checked + label.lbl-no { background: #e8f5e9; border-color: #2e7d32; color: #2e7d32; } 
        .yn-btn input:checked + label.lbl-yes { background: #ffebee; border-color: #c62828; color: #c62828; }
    </style>
</head>
<body>

    <div class="main-container">
        
        <div class="header header-ipos">
            <div id="inst-header-container" class="inst-header-container">
                <img id="inst-logo-img" class="inst-logo" src="" alt="Logo" style="display:none;">
                <div class="inst-info"><h3 id="inst-name-display"></h3><p id="inst-contact-display"></p></div>
            </div>
            <h1>心理痛苦温度计</h1>
            <p>NCCN 心理痛苦管理篩查</p>
        </div>

        <div id="blank-qr-header">
            <div style="display:flex; align-items:center; justify-content:center; gap:20px; border: 2px dashed #ccc; padding: 15px; border-radius: 8px;">
                <div id="blank-qrcode"></div>
                <div style="text-align:left;">
                    <h4 style="margin:0; color:#0061f2;">掃描開始</h4>
                    <small>掃描此二維碼在手機上填寫表格。</small>
                </div>
            </div>
        </div>

        <div class="nav-bar no-print">
            <a href="../../diagnostic.html" class="nav-link" id="backLink"><i class="bi bi-arrow-left"></i> 返回</a>
            <div class="nav-link" style="color:#6c757d; cursor:default;"><i class="bi bi-calendar-event"></i> <span id="dateDisplay"></span></div>
        </div>

        <form id="iposForm">
            
            <div class="question-card">
                <label class="q-label">Q1. 請圈出一個最能代表您在過去一週（包括今天）心理痛苦程度的數字（0-10）。</label>
                
                <div class="thermo-wrapper">
                    <div class="scale-column">
                        <div class="label-text text-extreme">極度痛苦</div>
                        <div class="scale-row"><label for="ds_10">10</label><input type="radio" name="distress_score" value="10" id="ds_10"></div>
                        <div class="scale-row"><label for="ds_9">9</label><input type="radio" name="distress_score" value="9" id="ds_9"></div>
                        <div class="scale-row"><label for="ds_8">8</label><input type="radio" name="distress_score" value="8" id="ds_8"></div>
                        <div class="scale-row"><label for="ds_7">7</label><input type="radio" name="distress_score" value="7" id="ds_7"></div>
                        <div class="scale-row"><label for="ds_6">6</label><input type="radio" name="distress_score" value="6" id="ds_6"></div>
                        <div class="scale-row"><label for="ds_5">5</label><input type="radio" name="distress_score" value="5" id="ds_5"></div>
                        <div class="scale-row"><label for="ds_4">4</label><input type="radio" name="distress_score" value="4" id="ds_4"></div>
                        <div class="scale-row"><label for="ds_3">3</label><input type="radio" name="distress_score" value="3" id="ds_3"></div>
                        <div class="scale-row"><label for="ds_2">2</label><input type="radio" name="distress_score" value="2" id="ds_2"></div>
                        <div class="scale-row"><label for="ds_1">1</label><input type="radio" name="distress_score" value="1" id="ds_1"></div>
                        <div class="scale-row"><label for="ds_0">0</label><input type="radio" name="distress_score" value="0" id="ds_0"></div>
                        <div class="label-text text-none">沒有痛苦</div>
                    </div>
                    <div class="image-column">
                        <img src="1.png" alt="温度计图示" class="thermo-img">
                    </div>
                </div>
            </div>

            <div class="question-card">
                <label class="q-label">問題清單：在過去一週（包括今天），您是否對以下項目感到困擾？</label>
                
                <div class="section-header" style="margin-top:0;">Q2. 身體問題</div>
                <div id="physical-section"></div>

                <div class="section-header">Q3. 情緒問題</div>
                <div id="emotional-section"></div>

                <div class="section-header">Q4. 生活實際問題</div>
                <div id="practical-section"></div>

                <div class="section-header">Q5. 交際/社會問題</div>
                <div id="social-section"></div>

                <div class="section-header">Q6. 靈性/宗教</div>
                <div id="spiritual-section"></div>

            </div>

            <div class="question-card">
                <label class="q-label">Q7. 其他問題：</label>
                <textarea class="form-control" id="other_concerns" rows="3" maxlength="200" 
                          style="width:100%; border:1px solid #ced4da; border-radius:6px; padding:10px; font-size:16px;" 
                          placeholder="請說明任何其他困擾..." 
                          oninput="updateCharCount(this)"></textarea>
                <small id="char-count" style="display:block; text-align:right; color:#6c757d; font-size:12px; margin-top:4px;">
                    已使用 0/200 個字元
                </small>
            </div>

            <div class="score-box no-print">
                <div><div class="score-title">心理痛苦分數</div><small style="opacity:0.7">0 (無痛苦) 至 10 (極度痛苦)</small></div>
                <div class="score-val" id="total-score-display">--</div>
            </div>

            <div id="qr-section">
                <div class="alert alert-success" style="background:#d4edda; color:#155724; padding:8px; border-radius:6px; margin-bottom:8px; font-size:12px;">
                    <i class="bi bi-check-circle-fill"></i> <strong>結果已生成！</strong>
                    <p style="margin:0; font-size:13px;">請向您的醫生出示此二維碼。</p>
                </div>
                <div id="qrcode-container" style="background:white; padding:8px; border-radius:8px; display:inline-block;">
                    <div id="qrcode"></div>
                    <div style="font-size:9px; color:#999; margin-top:4px;">NCCN-DT 安全數據</div>
                </div>
            </div>

            <div class="action-buttons no-print" style="margin-top:20px; display:flex; gap:8px; flex-direction:column;">
                <button type="button" class="btn btn-buccal" onclick="generateQR()" style="width:100%;">
                    <i class="bi bi-qr-code-scan"></i> 生成結果二維碼
                </button>
                <button type="button" class="btn btn-pdf" onclick="window.print()" style="width:100%;">
                    <i class="bi bi-printer"></i> 列印 / 儲存為 PDF
                </button>
            </div>
        </form>
    </div>

    <script>
        // --- DATA CONFIGURATION ---
        const physicalItems = [ {l:'疼痛'}, {l:'睡眠'}, {l:'疲倦'}, {l:'吸煙'}, {l:'藥物/物質使用'}, {l:'記憶力或注意力'}, {l:'性健康'}, {l:'飲食變化'}, {l:'身體機能喪失或變化'} ];
        const emotionalItems = [ {l:'憂慮或焦慮'}, {l:'悲傷或抑鬱'}, {l:'失去興趣或樂趣'}, {l:'哀慟或喪失感'}, {l:'恐懼'}, {l:'孤獨'}, {l:'憤怒'}, {l:'外觀變化'}, {l:'感到毫無價值或成為負擔'} ];
        const practicalItems = [ {l:'自我照顧'}, {l:'照顧他人'}, {l:'安全'}, {l:'工作'}, {l:'學業'}, {l:'住房/水電'}, {l:'財務'}, {l:'保險'}, {l:'交通'}, {l:'托兒'}, {l:'食物充足性'}, {l:'獲取藥物'}, {l:'治療決定'} ];
        const socialItems = [ {l:'與配偶或伴侶的關係'}, {l:'與子女的關係'}, {l:'與家人的關係'}, {l:'與朋友或同事的關係'}, {l:'與醫護團隊的溝通'}, {l:'生育能力'}, {l:'偏見或歧視'} ];
        const spiritualItems = [ {l:'生命的意義或目的'}, {l:'信仰或信念的變化'}, {l:'死亡、臨終或死後世界'}, {l:'信仰與癌症治療之間的衝突'}, {l:'與神聖力量的關係'}, {l:'儀式或飲食需求'} ];

        let dtContext = { mode: 'personal', instId: null };

        document.addEventListener('DOMContentLoaded', async () => {
            renderYesNoItems(physicalItems, 'physical-section', 'phy');
            renderYesNoItems(emotionalItems, 'emotional-section', 'emo');
            renderYesNoItems(practicalItems, 'practical-section', 'prac');
            renderYesNoItems(socialItems, 'social-section', 'soc');
            renderYesNoItems(spiritualItems, 'spiritual-section', 'spir');
            
            const dateDisplay = document.getElementById('dateDisplay');
            if(dateDisplay) dateDisplay.innerText = new Date().toLocaleDateString();
            
            const form = document.getElementById('iposForm');
            if(form) form.addEventListener('change', calculateTotalScore);

            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref');

            if (ref) {
                dtContext.mode = 'shared'; 
                dtContext.instId = ref;
                finalizeAppSetup(ref);
            } else {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        try {
                            const snap = await db.collection('users').doc(user.uid).get();
                            if (snap.exists) {
                                const userData = snap.data();
                                if (['institutionUser', 'institutionAdmin'].includes(userData.role)) {
                                    dtContext.mode = 'institution'; 
                                    dtContext.instId = userData.institutionId;
                                }
                            }
                        } catch (e) { console.error(e); }
                    }
                    finalizeAppSetup(dtContext.instId);
                });
            }
        });

        async function finalizeAppSetup(instId) {
            const blankQrHeader = document.getElementById('blank-qr-header');
            const backButton = document.getElementById('backLink');

            if (dtContext.mode === 'shared') {
                if(blankQrHeader) blankQrHeader.style.display = 'none';
                if(backButton) backButton.style.display = 'none';
            } else {
                if(blankQrHeader) {
                    blankQrHeader.style.display = 'block';
                    generateBlankFormQR(instId);
                }
                if(backButton) backButton.style.display = 'inline-flex';
            }
            
            if (typeof loadInstitutionHeader === "function" && instId) {
                await loadInstitutionHeader(instId);
            } else if (typeof loadPersonalHeader === "function") {
                loadPersonalHeader();
            }
        }

        function generateBlankFormQR(instId) {
            const qrContainer = document.getElementById("blank-qrcode");
            if (!qrContainer) return;
            qrContainer.innerHTML = ""; 
            const baseUrl = window.location.href.split('?')[0]; 
            const targetUrl = instId ? `${baseUrl}?ref=${instId}` : baseUrl;
            new QRCode(qrContainer, { text: targetUrl, width: 100, height: 100 });
        }

        function renderYesNoItems(items, containerId, prefix) {
            const container = document.getElementById(containerId);
            let html = '';
            items.forEach((item, index) => {
                const uniqueName = `${prefix}_${index}`;
                html += `
                <div class="yes-no-row">
                    <div class="yn-label">${item.l}</div>
                    <div class="yn-options">
                        <div class="yn-btn">
                            <input type="radio" name="${uniqueName}" value="0" id="${uniqueName}_no">
                            <label for="${uniqueName}_no" class="lbl-no">否</label>
                        </div>
                        <div class="yn-btn">
                            <input type="radio" name="${uniqueName}" value="1" id="${uniqueName}_yes">
                            <label for="${uniqueName}_yes" class="lbl-yes">是</label>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function calculateTotalScore() {
            let total = 0;
            const scoreEl = document.querySelector('input[name="distress_score"]:checked');
            const display = document.getElementById('total-score-display');
            if (scoreEl) {
                total = parseInt(scoreEl.value);
                display.innerText = total;
            } else {
                display.innerText = "--";
            }
            return total;
        }

        function updateCharCount(textarea) {
            const maxLength = textarea.getAttribute('maxlength');
            const currentLength = textarea.value.length;
            const counter = textarea.nextElementSibling;
            counter.innerText = `已使用 ${currentLength}/${maxLength} 個字元`;
        }

        function generateQR() {
            const modal = document.getElementById('pdpa-modal');
            if (modal) {
                modal.style.display = 'flex';
            } else {
                if(confirm("生成二維碼？點擊確定即表示您同意共享此數據。")) {
                    executeQRGeneration();
                }
            }
        }

        function executeQRGeneration() {
            const getVal = (name) => {
                const el = document.querySelector(`input[name="${name}"]:checked`);
                return el ? parseInt(el.value) : null; 
            };
            const getSuffix = (i) => String.fromCharCode(97 + i); 
            
            const distressScore = getVal('distress_score');

            const payload = {
                t: "dt", 
                d: Date.now(),
                score: distressScore,
                Q1: distressScore
            };

            physicalItems.forEach((_, i) => { payload[`Q2${getSuffix(i)}`] = getVal(`phy_${i}`); });
            emotionalItems.forEach((_, i) => { payload[`Q3${getSuffix(i)}`] = getVal(`emo_${i}`); });
            practicalItems.forEach((_, i) => { payload[`Q4${getSuffix(i)}`] = getVal(`prac_${i}`); });
            socialItems.forEach((_, i) => { payload[`Q5${getSuffix(i)}`] = getVal(`soc_${i}`); });
            spiritualItems.forEach((_, i) => { payload[`Q6${getSuffix(i)}`] = getVal(`spir_${i}`); });

            payload['Q7'] = document.getElementById('other_concerns').value.substring(0, 200);

            const qrDiv = document.getElementById("qrcode");
            qrDiv.innerHTML = "";
            
            const safeData = encodeURIComponent(JSON.stringify(payload));
            new QRCode(qrDiv, { text: safeData, width: 200, height: 200, correctLevel: QRCode.CorrectLevel.L });

            const section = document.getElementById('qr-section');
            section.style.display = 'block';
            section.scrollIntoView({behavior: 'smooth'});
        }
    </script>
</body>
</html>
