<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Distress Thermometer | PalliCalc</title>
    
    <link rel="stylesheet" href="../diagnostic.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="../diagnostic.js"></script>
</head>
<body>

    <div id="pdf-loading">
        <div style="text-align:center">
            <div style="display:inline-block; width: 3rem; height: 3rem; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 15px; font-weight: bold;">Preparing PDF...</p>
        </div>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } #pdf-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 3000; display: none; justify-content: center; align-items: center; flex-direction: column; }</style>
    </div>

    <div class="main-container">
        
        <div class="header header-ipos">
            <div id="inst-header-container" class="inst-header-container">
                <img id="inst-logo-img" class="inst-logo" src="" alt="Logo" style="display:none;">
                <div class="inst-info"><h3 id="inst-name-display"></h3><p id="inst-contact-display"></p></div>
            </div>
            <h1>Distress Thermometer</h1>
            <p>NCCN Distress Management Screening</p>
        </div>

        <div id="blank-qr-header">
            <div style="display:flex; align-items:center; justify-content:center; gap:20px; border: 2px dashed #ccc; padding: 15px; border-radius: 8px;">
                <div id="blank-qrcode"></div>
                <div style="text-align:left;">
                    <h4 style="margin:0; color:#0061f2;">Scan to Start</h4>
                    <small>Scan this code to fill the form on your phone.</small>
                </div>
            </div>
        </div>

        <div class="nav-bar no-print">
            <a href="../../diagnostic.html" class="nav-link" id="backLink"><i class="bi bi-arrow-left"></i> Back</a>
            <div class="nav-link" style="color:#6c757d; cursor:default;"><i class="bi bi-calendar-event"></i> <span id="dateDisplay"></span></div>
        </div>

        <form id="iposForm">
            
            <div class="question-card">
                <label class="q-label">Q1. Please circle the number (0-10) that best describes how much distress you have been experiencing in the past week, including today.</label>
                
                <div class="scale-container" style="flex-wrap: wrap;">
                    <div class="scale-opt"><input type="radio" name="distress_score" value="0" id="ds_0"><label for="ds_0">0<div class="scale-desc">No Distress</div></label></div>
                    <div class="scale-opt"><input type="radio" name="distress_score" value="1" id="ds_1"><label for="ds_1">1</label></div>
                    <div class="scale-opt"><input type="radio" name="distress_score" value="2" id="ds_2"><label for="ds_2">2</label></div>
                    <div class="scale-opt"><input type="radio" name="distress_score" value="3" id="ds_3"><label for="ds_3">3</label></div>
                    <div class="scale-opt"><input type="radio" name="distress_score" value="4" id="ds_4"><label for="ds_4">4</label></div>
                    <div class="scale-opt"><input type="radio" name="distress_score" value="5" id="ds_5"><label for="ds_5">5</label></div>
                    <div class="scale-opt"><input type="radio" name="distress_score" value="6" id="ds_6"><label for="ds_6">6</label></div>
                    <div class="scale-opt"><input type="radio" name="distress_score" value="7" id="ds_7"><label for="ds_7">7</label></div>
                    <div class="scale-opt"><input type="radio" name="distress_score" value="8" id="ds_8"><label for="ds_8">8</label></div>
                    <div class="scale-opt"><input type="radio" name="distress_score" value="9" id="ds_9"><label for="ds_9">9</label></div>
                    <div class="scale-opt"><input type="radio" name="distress_score" value="10" id="ds_10"><label for="ds_10">10<div class="scale-desc" style="color:#d32f2f;">Extreme</div></label></div>
                </div>
            </div>

            <div class="question-card">
                <label class="q-label">Q2. Problem List: Have you had concerns about any of the items below in the past week, including today?</label>
                
                <style>
                    .yes-no-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
                    .yes-no-row:last-child { border-bottom: none; }
                    .yn-label { font-size: 15px; color: #333; flex: 1; padding-right: 10px; }
                    .yn-options { display: flex; gap: 5px; width: 100px; }
                    .section-header { background: #f8f9fa; padding: 8px; margin: 15px -20px 10px -20px; font-weight: 700; color: #0061f2; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
                </style>

                <div class="section-header" style="margin-top:0;">Physical Concerns</div>
                <div id="physical-section"></div>

                <div class="section-header">Emotional Concerns</div>
                <div id="emotional-section"></div>

                <div class="section-header">Practical Concerns</div>
                <div id="practical-section"></div>

                <div class="section-header">Social Concerns</div>
                <div id="social-section"></div>

                <div class="section-header">Spiritual / Religious</div>
                <div id="spiritual-section"></div>

            </div>

            <div class="question-card">
                <label class="q-label">Other Concerns:</label>
                <textarea class="form-control" id="other_concerns" rows="3" maxlength="200" 
                          style="width:100%; border:1px solid #ced4da; border-radius:6px; padding:10px; font-size:16px;" 
                          placeholder="Please describe any other concerns..." 
                          oninput="updateCharCount(this)"></textarea>
                <small id="char-count" style="display:block; text-align:right; color:#6c757d; font-size:12px; margin-top:4px;">
                    0/200
                </small>
            </div>

            <div class="score-box no-print">
                <div><div class="score-title">Distress Score</div><small style="opacity:0.7">0 (No Distress) to 10 (Extreme)</small></div>
                <div class="score-val" id="total-score-display">0</div>
            </div>

            <div id="qr-section">
                <div class="alert alert-success" style="background:#d4edda; color:#155724; padding:8px; border-radius:6px; margin-bottom:8px; font-size:12px;">
                    <i class="bi bi-check-circle-fill"></i> <strong>Result Ready!</strong>
                    <p style="margin:0; font-size:13px;">Show this QR to your doctor.</p>
                </div>
                <div id="qrcode-container" style="background:white; padding:8px; border-radius:8px; display:inline-block;">
                    <div id="qrcode"></div>
                    <div style="font-size:9px; color:#999; margin-top:4px;">NCCN-DT Secure Payload</div>
                </div>
            </div>

            <div class="action-buttons no-print" style="margin-top:20px; display:flex; gap:8px; flex-direction:column;">
                <button type="button" class="btn btn-buccal" onclick="generateQR()" style="width:100%;">
                    <i class="bi bi-qr-code-scan"></i> Generate Result QR
                </button>
                <button type="button" class="btn btn-pdf" onclick="window.print()" style="width:100%;">
                    <i class="bi bi-printer"></i> Print / Save as PDF
                </button>
            </div>
        </form>

    </div>

    <script>
        // --- 1. CONFIGURATION: List of Questions ---
        const physicalItems = [
            {id:'phy_pain', l:'Pain'}, {id:'phy_sleep', l:'Sleep'}, {id:'phy_fatigue', l:'Fatigue'}, 
            {id:'phy_tobacco', l:'Tobacco use'}, {id:'phy_substance', l:'Substance use'}, 
            {id:'phy_mem', l:'Memory/Concentration'}, {id:'phy_sex', l:'Sexual health'}, 
            {id:'phy_eat', l:'Changes in eating'}, {id:'phy_abil', l:'Loss of physical abilities'}
        ];
        const emotionalItems = [
            {id:'emo_worry', l:'Worry or anxiety'}, {id:'emo_sad', l:'Sadness or depression'}, 
            {id:'emo_int', l:'Loss of interest'}, {id:'emo_grief', l:'Grief or loss'}, 
            {id:'emo_fear', l:'Fear'}, {id:'emo_lone', l:'Loneliness'}, 
            {id:'emo_anger', l:'Anger'}, {id:'emo_app', l:'Changes in appearance'}, 
            {id:'emo_worth', l:'Worthlessness/Burden'}
        ];
        const practicalItems = [
            {id:'prac_self', l:'Taking care of myself'}, {id:'prac_others', l:'Taking care of others'}, 
            {id:'prac_safe', l:'Safety'}, {id:'prac_work', l:'Work'}, {id:'prac_school', l:'School'}, 
            {id:'prac_house', l:'Housing/Utilities'}, {id:'prac_fin', l:'Finances'}, 
            {id:'prac_ins', l:'Insurance'}, {id:'prac_trans', l:'Transportation'}, 
            {id:'prac_child', l:'Child care'}, {id:'prac_food', l:'Having enough food'}, 
            {id:'prac_med', l:'Access to medicine'}, {id:'prac_tx', l:'Treatment decisions'}
        ];
        const socialItems = [
            {id:'soc_spouse', l:'Rel. w/ spouse/partner'}, {id:'soc_child', l:'Rel. w/ children'}, 
            {id:'soc_fam', l:'Rel. w/ family'}, {id:'soc_friend', l:'Rel. w/ friends'}, 
            {id:'soc_team', l:'Comm. w/ health team'}, {id:'soc_fert', l:'Ability to have children'}, 
            {id:'soc_disc', l:'Prejudice/Discrimination'}
        ];
        const spiritualItems = [
            {id:'spir_mean', l:'Meaning or purpose'}, {id:'spir_faith', l:'Changes in faith/beliefs'}, 
            {id:'spir_death', l:'Death, dying, afterlife'}, {id:'spir_conf', l:'Conflict beliefs/treatment'}, 
            {id:'spir_sacred', l:'Rel. w/ the sacred'}, {id:'spir_rit', l:'Ritual or dietary needs'}
        ];

        // --- 2. INITIALIZATION: Build the Form Dynamically ---
        function renderYesNoItems(items, containerId) {
            const container = document.getElementById(containerId);
            let html = '';
            items.forEach(item => {
                html += `
                <div class="yes-no-row">
                    <div class="yn-label">${item.l}</div>
                    <div class="yn-options">
                        <div class="scale-opt" style="flex:1;">
                            <input type="radio" name="${item.id}" value="0" id="${item.id}_0" checked>
                            <label for="${item.id}_0">No</label>
                        </div>
                        <div class="scale-opt" style="flex:1;">
                            <input type="radio" name="${item.id}" value="1" id="${item.id}_1">
                            <label for="${item.id}_1" style="font-weight:bold;">Yes</label>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderYesNoItems(physicalItems, 'physical-section');
            renderYesNoItems(emotionalItems, 'emotional-section');
            renderYesNoItems(practicalItems, 'practical-section');
            renderYesNoItems(socialItems, 'social-section');
            renderYesNoItems(spiritualItems, 'spiritual-section');
            
            // Re-attach listeners for the new inputs
            const form = document.getElementById('iposForm');
            if(form) form.addEventListener('change', calculateTotalScore);
        });

        // --- 3. LOGIC ---
        function calculateTotalScore() {
            // For Distress Thermometer, the Score is just Question 1 (0-10)
            let total = 0;
            const scoreEl = document.querySelector('input[name="distress_score"]:checked');
            if (scoreEl) total = parseInt(scoreEl.value);

            const display = document.getElementById('total-score-display');
            if(display) display.innerText = total;
            
            // Visual feedback on yes/no items (optional)
            // We could count total problems here if needed, but per request, we display the thermometer score.
            return total;
        }

        function updateCharCount(textarea) {
            const maxLength = textarea.getAttribute('maxlength');
            const currentLength = textarea.value.length;
            const counter = textarea.nextElementSibling; // The <small> tag
            counter.innerText = `${currentLength}/${maxLength}`;
        }

        function generateQR() {
            // Helper to get value
            const getVal = (name) => {
                const el = document.querySelector(`input[name="${name}"]:checked`);
                return el ? parseInt(el.value) : 0;
            };

            // Build payload
            const payload = {
                t: "NCCN-DT",
                d: Date.now(),
                score: getVal('distress_score'),
                other: document.getElementById('other_concerns').value.substring(0, 200),
                probs: {} // Object to hold the yes/no answers
            };

            // Populate Checklists
            const allLists = [...physicalItems, ...emotionalItems, ...practicalItems, ...socialItems, ...spiritualItems];
            allLists.forEach(item => {
                // To save space in QR, we only map if YES (1)
                // Or we can map all. Let's map all for consistency.
                payload.probs[item.id] = getVal(item.id);
            });

            const qrDiv = document.getElementById("qrcode");
            qrDiv.innerHTML = "";
            
            // Generate QR
            const safeData = encodeURIComponent(JSON.stringify(payload));
            new QRCode(qrDiv, { text: safeData, width: 200, height: 200, correctLevel: QRCode.CorrectLevel.L });

            const section = document.getElementById('qr-section');
            section.style.display = 'block';
            section.scrollIntoView({behavior: 'smooth'});
        }

        // Overwrite printPDF to default window.print since we don't have a background PDF
        // If you have a specific PDF background, you can uncomment the logic from ipos.html
        function printPDF() {
            window.print();
        }
    </script>
</body>
</html>
