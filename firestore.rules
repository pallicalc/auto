rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    /* ===============================
       1. INSTITUTIONS (Safe for App & Counters)
       =============================== */
    match /institutions/{instId} {
      allow list: if true;
      allow get: if !('status' in resource.data) || resource.data.status != 'suspended';
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.adminUid;
    }
    /* ===============================
       2. USERS (Standard)
       =============================== */
    match /users/{userId} {
      allow list: if true;
      allow get: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'institutionAdmin');
      allow write: if request.auth != null;
    }
    /* ===============================
       3. FEEDBACK (Standard)
       =============================== */
    match /feedback/{docId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    /* ===============================
       4. ADMIN FEEDBACK (Standard)
       =============================== */
    match /adminFeedback/{docId} {
      allow create: if request.auth != null;
      allow read, update, delete: if false;
    }
    /* ===============================
       5. OPIOID RATIOS (FAIL-SAFE SECURITY)
       =============================== */
    match /opioidRatios/{institutionId} {
      function isSuspended() {
        let instPath = /databases/$(database)/documents/institutions/$(institutionId);
        return exists(instPath) && 'status' in get(instPath).data && get(instPath).data.status == 'suspended';
      }
      allow read: if request.auth != null && !isSuspended();
      allow create, update, delete: if request.auth != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "institutionAdmin"
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.institutionId == institutionId;
    }
    /* ===============================
       6. BENZO RATIOS (FAIL-SAFE SECURITY)
       =============================== */
    match /benzoRatios/{institutionId} {
      function isSuspended() {
        let instPath = /databases/$(database)/documents/institutions/$(institutionId);
        return exists(instPath) && 'status' in get(instPath).data && get(instPath).data.status == 'suspended';
      }
      allow read: if request.auth != null && !isSuspended();
      allow create, update, delete: if request.auth != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "institutionAdmin"
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.institutionId == institutionId;
    }
    /* ===============================
       7. SETTINGS (Public Pricing Fetch)
       =============================== */
    match /setting/{document=**} {
      allow read: if true;
      allow write: if request.auth != null;
    }
  }
}
