<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Management | PalliCalc</title>
  
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    body { background: #f5f7fa; min-height: 100vh; }
    
    /* Card Container */
    .user-card { 
        background: white; 
        border-radius: 12px; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        border: 1px solid transparent; 
        transition: all 0.2s ease;
        padding: 16px;
        display: flex;
        align-items: center; 
        gap: 15px; 
    }

    /* Pending State (Red Background) */
    .user-card.pending {
        background-color: #fff5f5; 
        border-color: #f5c2c7;
    }

    /* Icon Circle */
    .user-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background-color: #e9ecef;
        color: #0d6efd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        flex-shrink: 0; 
    }

    .user-card.pending .user-avatar {
        background-color: #f8d7da;
        color: #dc3545;
    }

    /* Text Area */
    .user-info {
        flex-grow: 1; 
        min-width: 0; 
    }

    .user-email {
        font-weight: 600;
        color: #212529;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis; 
    }
    
    .user-card.pending .user-email {
        text-decoration: line-through;
        color: #6c757d;
    }

    .user-role {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .deletion-notice {
        font-size: 0.75rem;
        color: #dc3545;
        font-weight: 700;
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* Button Area */
    .user-action {
        flex-shrink: 0; 
    }
    
    /* New: Cache Info Text */
    .cache-info { font-size: 0.8rem; color: #adb5bd; text-align: right; margin-bottom: 10px; }
    .btn-sync { padding: 0; font-size: 0.8rem; text-decoration: none; font-weight: bold; }
  </style>
</head>
<body>

  <nav class="navbar navbar-light bg-white shadow-sm mb-4">
    <div class="container">
      <a href="../admin.html" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
      </a>
      <span class="navbar-brand mb-0 h1 mx-auto">Staff Management</span>
      <div style="width: 80px;"></div> 
    </div>
  </nav>

  <div class="container" style="max-width: 700px;">
    
    <div class="alert alert-info border-0 shadow-sm mb-4">
      <div class="d-flex">
          <i class="bi bi-info-circle-fill me-3 fs-4"></i>
          <div>
              <strong>How Deletion Works:</strong><br>
              Clicking "Remove" starts a <strong>14-day countdown</strong>. You can restore the account anytime before the date shown.
          </div>
      </div>
    </div>

    <div class="cache-info">
        <span id="lastUpdatedTime">Checking...</span>
        <button onclick="fetchStaffFromCloud()" class="btn btn-link btn-sync ms-2">
            <i class="bi bi-arrow-clockwise"></i> Sync List
        </button>
    </div>

    <div id="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2 text-muted">Loading staff list...</p>
    </div>

    <div id="userList" class="row g-3"></div>

  </div>

  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyAioaDxAEh3Cd-8Bvad9RgWXoOzozGeE_s",
        authDomain: "pallicalc-eabdc.firebaseapp.com",
        projectId: "pallicalc-eabdc",
        storageBucket: "pallicalc-eabdc.firebasestorage.app",
        messagingSenderId: "347532270864",
        appId: "1:347532270864:web:bfe5bd1b92ccec22dc5995"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentInstId = null;

    // --- MAIN LOGIC ---
    auth.onAuthStateChanged(async (adminUser) => {
      if (!adminUser) return window.location.href = '../index.html';

      const adminDoc = await db.collection('users').doc(adminUser.uid).get();
      if (!adminDoc.exists) return; 

      currentInstId = adminDoc.data().institutionId;

      // START: Check Cache first!
      loadStaffFromCache();
    });

    // 1. TRY CACHE
    function loadStaffFromCache() {
        const cachedData = localStorage.getItem(`staff_${currentInstId}`);
        const cachedTime = localStorage.getItem(`staffTime_${currentInstId}`);
        const now = new Date().getTime();
        const oneDay = 24 * 60 * 60 * 1000;

        if (cachedData && cachedTime && (now - cachedTime < oneDay)) {
            console.log("Loaded from Cache (0 Reads)");
            renderList(JSON.parse(cachedData));
            updateTimeLabel(parseInt(cachedTime));
        } else {
            console.log("Cache expired. Fetching...");
            fetchStaffFromCloud();
        }
    }

    // 2. FETCH CLOUD (Costs Reads)
    async function fetchStaffFromCloud() {
      const loading = document.getElementById('loading');
      const listDiv = document.getElementById('userList');
      
      loading.style.display = 'block';
      listDiv.innerHTML = '';

      try {
        const snapshot = await db.collection('users')
          .where('institutionId', '==', currentInstId)
          .get();

        const staffArray = [];
        snapshot.forEach(doc => {
          if (doc.id === auth.currentUser.uid) return; 
          
          const data = doc.data();
          data.uid = doc.id; // Store ID for logic
          
          // Fix Timestamps for JSON storage
          if (data.gracePeriodEnd && data.gracePeriodEnd.toDate) {
             data.gracePeriodEnd = data.gracePeriodEnd.toDate().toISOString();
          }
          staffArray.push(data);
        });

        // Save to Cache
        localStorage.setItem(`staff_${currentInstId}`, JSON.stringify(staffArray));
        localStorage.setItem(`staffTime_${currentInstId}`, new Date().getTime());

        renderList(staffArray);
        updateTimeLabel(new Date().getTime());
        
      } catch (error) {
        console.error(error);
        listDiv.innerHTML = `<p class="text-danger text-center">Error loading staff.</p>`;
      }
      loading.style.display = 'none';
    }

    // 3. RENDER UI (Your Exact Design)
    function renderList(staffArray) {
      const listDiv = document.getElementById('userList');
      
      if (staffArray.length === 0) {
          listDiv.innerHTML = '<div class="col-12 text-center mt-5 text-muted">No other staff members found.</div>';
          document.getElementById('loading').style.display = 'none';
          return;
      }

      let html = '';
      staffArray.forEach(u => {
          // Recreate Timestamp object if string (from cache)
          const isPending = !!u.gracePeriodEnd;
          let scheduledDate = '';
          
          if (isPending) {
             const d = new Date(u.gracePeriodEnd);
             scheduledDate = d.toLocaleDateString('en-GB');
          }

          html += `
          <div class="col-12">
            <div class="user-card ${isPending ? 'pending' : ''}">
              
              <div class="user-avatar">
                <i class="bi bi-person-fill"></i>
              </div>

              <div class="user-info">
                <div class="user-email" title="${u.email}">${u.email}</div>
                <div class="user-role">Role: ${u.role || 'Member'}</div>
                
                ${isPending ? `
                    <div class="deletion-notice">
                        <i class="bi bi-hourglass-split"></i> 
                        Deletion Date: ${scheduledDate}
                    </div>` 
                : ''}
              </div>

              <div class="user-action">
                ${isPending 
                  ? `<button onclick="revokeDeletion('${u.uid}')" class="btn btn-sm btn-success shadow-sm px-3 fw-bold">
                       <i class="bi bi-arrow-counterclockwise me-1"></i> Restore
                     </button>`
                  : `<button onclick="requestDeletion('${u.uid}', '${u.email}')" class="btn btn-sm btn-outline-danger px-3">
                       <i class="bi bi-trash me-1"></i> Remove
                     </button>`
                }
              </div>

            </div>
          </div>`;
      });
      listDiv.innerHTML = html;
      document.getElementById('loading').style.display = 'none';
    }

    function updateTimeLabel(ts) {
        const date = new Date(ts);
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        document.getElementById('lastUpdatedTime').innerText = `Last synced: Today ${timeStr}`;
    }

    // --- ACTIONS (Updated to refresh Cache instead of Reload) ---
    async function requestDeletion(userId, userEmail) {
      if (!confirm(`Schedule removal for ${userEmail}?\n\nThey will receive an email and have 14 days.`)) return;

      try {
        const fourteenDaysLater = new Date();
        fourteenDaysLater.setDate(fourteenDaysLater.getDate() + 14);

        await db.collection('users').doc(userId).update({
          deletionStatus: "pending",
          deletionRequestedAt: firebase.firestore.FieldValue.serverTimestamp(),
          gracePeriodEnd: firebase.firestore.Timestamp.fromDate(fourteenDaysLater),
          deletedBy: auth.currentUser.email
        });

        alert("Scheduled for deletion.");
        fetchStaffFromCloud(); // Refresh list to update UI

      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    async function revokeDeletion(userId) {
      if (!confirm("Restore this user account?")) return;

      try {
        await db.collection('users').doc(userId).update({
          deletionStatus: firebase.firestore.FieldValue.delete(),
          gracePeriodEnd: firebase.firestore.FieldValue.delete(),
          deletionRequestedAt: firebase.firestore.FieldValue.delete(),
          deletedBy: firebase.firestore.FieldValue.delete()
        });

        alert("Restored.");
        fetchStaffFromCloud(); // Refresh list

      } catch (err) {
        alert("Error: " + err.message);
      }
    }
  </script>
<script src="/js/ga-tracking.js"></script>
</body>
</html>
