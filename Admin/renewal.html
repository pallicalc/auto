<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subscription Renewal | PalliCalc</title>
  
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-functions-compat.js"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    body { background: #f5f7fa; min-height: 100vh; }
    .bill-card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 30px; }
    .status-active { color: #198754; font-weight: bold; }
    .status-pending { color: #ffc107; font-weight: bold; } /* Yellow for Pending */
    .status-due { color: #fd7e14; font-weight: bold; }
    .status-suspended { color: #dc3545; font-weight: bold; }
    .blur-overlay { filter: blur(4px); pointer-events: none; opacity: 0.6; }
    .lock-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; text-align: center; width: 80%; }
    
    /* FINANCIAL AID BOX STYLE */
    .aid-box { 
        background: #e3f2fd; 
        border-left: 5px solid #2196f3; 
        padding: 15px; 
        margin-top: 25px; 
        border-radius: 4px; 
    }
    .aid-box a { color: #0d6efd; text-decoration: none; font-weight: bold; }
    .aid-box a:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <nav class="navbar navbar-light bg-white shadow-sm mb-5">
    <div class="container">
      <a href="../admin.html" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Dashboard
      </a>
      <span class="navbar-brand mb-0 h1 mx-auto">Subscription Renewal</span>
      <div style="width: 80px;"></div>
    </div>
  </nav>

  <div class="container" style="max-width: 900px;">

    <div id="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2 text-muted">Analyzing account...</p>
    </div>

    <div id="billingContent" class="row d-none">
      
      <div class="col-lg-7 mb-4">
        <div class="bill-card h-100">
          <h4 class="mb-4"><i class="bi bi-receipt me-2"></i>Renewal Invoice</h4>
          
          <div class="mb-4 border-bottom pb-3">
            <h5 id="instName">Loading...</h5>
            <div class="d-flex justify-content-between mt-2"><span>Country:</span> <strong id="countryDisplay">-</strong></div>
            <div class="d-flex justify-content-between mt-1"><span>Status:</span> <span id="statusBadge">Checking...</span></div>
            <div class="d-flex justify-content-between mt-1"><span>Paid Until:</span> <strong id="paidUntilDate">-</strong></div>
          </div>

          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
              <span>Active Staff Members:</span> <strong id="userCount">0</strong>
            </div>
          </div>

          <table class="table table-borderless">
            <tbody>
              <tr>
                <td>Annual Base Fee (<span id="tierName">Tier 1</span>)</td>
                <td class="text-end"><span id="currencySymbol">RM</span> <span id="basePrice">0.00</span></td>
              </tr>
              <tr id="discountRow" class="text-success d-none">
                <td><i class="bi bi-tag-fill me-1"></i>Discount (<span id="discountPercent">0</span>%)</td>
                <td class="text-end">- <span id="currencySymbolDisc">RM</span> <span id="discountAmount">0.00</span></td>
              </tr>
              <tr id="reactivationRow" class="text-danger d-none">
                <td>Reactivation Penalty</td>
                <td class="text-end"><span id="currencySymbolPen">RM</span> <span id="penaltyPrice">50.00</span></td>
              </tr>
              <tr class="border-top">
                <td class="pt-3 fw-bold">Total Due</td>
                <td class="pt-3 text-end fw-bold fs-5"><span id="currencySymbolTotal">RM</span> <span id="totalPrice">0.00</span></td>
              </tr>
            </tbody>
          </table>
          
          <div id="freeTrialMsg" class="alert alert-success d-none">
            <i class="bi bi-gift-fill me-2"></i> <strong>First Year Free!</strong>
          </div>

          <div class="aid-box">
             <div class="d-flex">
                <i class="bi bi-info-circle-fill text-primary me-3 fs-4"></i>
                <div>
                   <strong>Financial Support Available</strong><br>
                   <small class="text-muted" style="line-height: 1.4; display:block; margin-bottom:5px;">
                     We support NGOs and institutions with financial constraints. Contact us for a partial or full fee waiver.
                   </small>
                   <a href="mailto:support@pallicalc.com?subject=Financial Aid Request">Email support@pallicalc.com &rarr;</a>
                </div>
             </div>
          </div>
        </div>
      </div>

      <div class="col-lg-5 mb-4 position-relative">
        
        <div id="paymentLock" class="d-none">
            <div class="lock-message bg-white p-4 shadow rounded border">
                <i class="bi bi-check-circle-fill text-success fs-1 mb-2"></i>
                <h5 id="lockTitle">No Payment Needed</h5>
                <p id="lockDesc" class="text-muted small mb-0">Subscription active.</p>
            </div>
        </div>

        <div id="paymentMethods" class="bill-card h-100">
          <h5 class="mb-4">Select Payment Method</h5>
          
          <div id="methodMalaysia" class="d-none">
              <div class="d-grid gap-3">
                <button onclick="toggleQR()" class="btn btn-outline-primary py-3 text-start">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-qr-code-scan fs-3 me-3"></i>
                    <div><div class="fw-bold">DuitNow QR</div><small class="text-muted">Instant Transfer</small></div>
                  </div>
                </button>
                <div id="qrSection" class="bg-light p-3 rounded text-center d-none">
                    <p class="small text-muted mb-2">Scan or Transfer <strong>RM <span id="qrAmount">0.00</span></strong></p>
                    <img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg" style="width:120px; opacity:0.5;" class="mb-2">
                    <div class="small fw-bold">Public Bank: 1234567890</div>
                </div>
              </div>
          </div>

          <div id="methodInternational" class="d-none">
              <div class="d-grid gap-3">
                <div class="alert alert-secondary border-0 small"><i class="bi bi-globe me-1"></i> International (USD)</div>
                <a href="#" id="stripeLink" target="_blank" class="btn btn-outline-dark py-3 text-start">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-credit-card-2-front fs-3 me-3"></i>
                    <div><div class="fw-bold">Pay with Card (Stripe)</div><small class="text-muted">Secure Payment</small></div>
                  </div>
                </a>
              </div>
          </div>

          <div class="mt-4 pt-3 border-top">
             <label class="form-label small fw-bold text-muted">Confirm Payment</label>
             <input type="text" id="txnRefInput" class="form-control mb-2" placeholder="Transaction / Receipt Ref No.">
             
             <button id="btnPaid" onclick="reportPayment()" class="btn btn-success w-100 fw-bold">
                <i class="bi bi-check-circle me-1"></i> I Have Paid
             </button>
             <small class="text-muted d-block mt-2 text-center" style="font-size: 0.75rem;">
                 System will grant 1-year access immediately.<br>Admin will verify receipt later.
             </small>
             <small id="paymentMsg" class="text-danger d-block mt-2 text-center"></small>
          </div>

        </div>
      </div>

    </div>
  </div>

  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyAioaDxAEh3Cd-8Bvad9RgWXoOzozGeE_s",
        authDomain: "pallicalc-eabdc.firebaseapp.com",
        projectId: "pallicalc-eabdc",
        storageBucket: "pallicalc-eabdc.firebasestorage.app",
        messagingSenderId: "347532270864",
        appId: "1:347532270864:web:bfe5bd1b92ccec22dc5995"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- CONFIG ---
    const PRICES_MYR = { 1: 100, 2: 300, 3: 500 }; 
    const PENALTY_MYR = 50;
    const PRICES_USD = { 1: 25, 2: 75, 3: 125 }; 
    const PENALTY_USD = 15;
    
    // UPDATE THESE WITH YOUR REAL STRIPE LINKS LATER
    const STRIPE_LINKS = { 1: "https://buy.stripe.com/test_tier1", 2: "#", 3: "#" };

    auth.onAuthStateChanged(async (user) => {
        if (!user) return window.location.href = '../index.html';
        
        const adminDoc = await db.collection('users').doc(user.uid).get();
        const adminData = adminDoc.data();
        
        if (adminData.isMoH) { alert("MOH is free."); window.location.href = '../admin.html'; return; }

        const instId = adminData.institutionId;
        const instDoc = await db.collection('institutions').doc(instId).get();
        const instData = instDoc.data();
        const countSnap = await db.collection('users').where('institutionId', '==', instId).count().get();
        const memberCount = countSnap.data().count;

        // 1. Determine Country
        const country = adminData.country || "Malaysia";
        const isMalaysia = (country.trim().toLowerCase() === "malaysia");
        const symbol = isMalaysia ? "RM" : "USD";
        document.getElementById('countryDisplay').textContent = country;

        // 2. Determine Tier
        let basePrice = 0; let tierLevel = 1; let tierName = "";
        if (memberCount <= 10) { tierLevel = 1; tierName = "Tier 1 (1-10)"; }
        else if (memberCount <= 50) { tierLevel = 2; tierName = "Tier 2 (11-50)"; }
        else { tierLevel = 3; tierName = "Enterprise"; }

        const priceList = isMalaysia ? PRICES_MYR : PRICES_USD;
        const penaltyFee = isMalaysia ? PENALTY_MYR : PENALTY_USD;
        basePrice = priceList[tierLevel];

        // 3. Discount Logic
        let discountPercent = adminData.manualDiscount || 0;
        let discountAmt = basePrice * (discountPercent / 100);
        let total = basePrice - discountAmt;

        document.getElementById('instName').textContent = instData.name || "Institution";
        document.getElementById('userCount').textContent = memberCount;
        document.getElementById('tierName').textContent = tierName;
        document.querySelectorAll('[id^="currencySymbol"]').forEach(el => el.textContent = symbol);
        document.getElementById('basePrice').textContent = basePrice.toFixed(2);
        
        if (discountPercent > 0) {
            document.getElementById('discountRow').classList.remove('d-none');
            document.getElementById('discountPercent').textContent = discountPercent;
            document.getElementById('discountAmount').textContent = discountAmt.toFixed(2);
        }

        if (adminData.hasPaidOnce === false && discountPercent !== 100) {
            total = 0;
            document.getElementById('freeTrialMsg').classList.remove('d-none');
        }

        // 4. Status & Penalty Logic
        const paidUntil = adminData.subscriptionEnd ? adminData.subscriptionEnd.toDate() : new Date();
        const now = new Date();
        const paymentWindow = new Date(paidUntil); paymentWindow.setMonth(paymentWindow.getMonth() - 1);
        const graceEnd = new Date(paidUntil); graceEnd.setMonth(graceEnd.getMonth() + 1);

        let lockPayment = false;
        let statusHtml = "";
        let lockTitle = "No Payment Needed";
        let lockDesc = "Your subscription is active.";

        // Logic Check:
        if (adminData.paymentNeedsAudit === true) { 
             // Shows YELLOW if they used the Trust System
             statusHtml = '<span class="status-pending">Pending Verification</span>';
             lockPayment = true;
             lockTitle = "Payment Reported";
             lockDesc = "Your receipt is being verified. You have full access.";
        } else if (total === 0) {
             statusHtml = '<span class="status-active">Free / Paid</span>';
             lockPayment = true; 
        } else if (now < paymentWindow) {
             statusHtml = '<span class="status-active">Active</span>';
             lockPayment = true;
        } else if (now >= paymentWindow && now <= graceEnd) {
             statusHtml = '<span class="status-due">Renewal Due</span>';
        } else {
             // SUSPENDED -> Add Penalty
             statusHtml = '<span class="status-suspended">Suspended</span>';
             document.getElementById('reactivationRow').classList.remove('d-none');
             document.getElementById('penaltyPrice').textContent = penaltyFee.toFixed(2);
             total += penaltyFee;
        }

        document.getElementById('statusBadge').innerHTML = statusHtml;
        document.getElementById('paidUntilDate').textContent = paidUntil.toLocaleDateString('en-GB');
        document.getElementById('totalPrice').textContent = total.toFixed(2);

        // 5. Show Correct Payment Method
        if (isMalaysia) {
            document.getElementById('methodMalaysia').classList.remove('d-none');
            document.getElementById('qrAmount').textContent = total.toFixed(2);
        } else {
            document.getElementById('methodInternational').classList.remove('d-none');
            document.getElementById('stripeLink').href = STRIPE_LINKS[tierLevel];
        }

        document.getElementById('loading').classList.add('d-none');
        document.getElementById('billingContent').classList.remove('d-none');
        
        if (lockPayment) {
            document.getElementById('paymentMethods').classList.add('blur-overlay');
            document.getElementById('paymentLock').classList.remove('d-none');
            document.getElementById('lockTitle').textContent = lockTitle;
            document.getElementById('lockDesc').textContent = lockDesc;
        }
    });

    function toggleQR() { document.getElementById('qrSection').classList.toggle('d-none'); }

    // --- TRUST SYSTEM SUBMISSION ---
    async function reportPayment() {
        const refNo = document.getElementById('txnRefInput').value;
        const msg = document.getElementById('paymentMsg');
        const btn = document.getElementById('btnPaid');

        if (!refNo) {
            alert("Please enter the Reference Number (Transaction ID) from your bank receipt.");
            return;
        }

        if(!confirm("Confirm you have paid RM " + document.getElementById('totalPrice').textContent + "?\n\nAccess will be renewed for 1 year immediately.")) return;

        btn.disabled = true;
        btn.textContent = "Verifying...";

        try {
            const reportFn = firebase.functions().httpsCallable('reportPayment');
            const result = await reportFn({ referenceNo: refNo });
            
            if (result.data.success) {
                alert("Success! Your subscription has been renewed for 1 year.\n\nWe will audit the receipt ID: " + refNo);
                location.reload();
            }
        } catch (error) {
            msg.textContent = error.message;
            btn.disabled = false;
            btn.textContent = "Try Again";
        }
    }
  </script>
</body>
</html>
