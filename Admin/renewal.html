<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subscription Renewal | PalliCalc</title>
  
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    body { background: #f5f7fa; min-height: 100vh; }
    .bill-card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 30px; }
    .price-tag { font-size: 2.5rem; font-weight: bold; color: #212529; }
    .status-active { color: #198754; font-weight: bold; }
    .status-due { color: #fd7e14; font-weight: bold; }
    .status-suspended { color: #dc3545; font-weight: bold; }
    .blur-overlay { filter: blur(4px); pointer-events: none; opacity: 0.6; }
    .lock-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; text-align: center; width: 80%; }
  </style>
</head>
<body>

  <nav class="navbar navbar-light bg-white shadow-sm mb-5">
    <div class="container">
      <a href="../admin.html" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Dashboard
      </a>
      <span class="navbar-brand mb-0 h1 mx-auto">Subscription Renewal</span>
      <div style="width: 80px;"></div>
    </div>
  </nav>

  <div class="container" style="max-width: 900px;">

    <div id="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2 text-muted">Analyzing account tier and billing status...</p>
    </div>

    <div id="billingContent" class="row d-none">
      
      <div class="col-lg-7 mb-4">
        <div class="bill-card h-100">
          <h4 class="mb-4"><i class="bi bi-receipt me-2"></i>Renewal Invoice</h4>
          
          <div class="mb-4 border-bottom pb-3">
            <label class="text-muted small">Institution</label>
            <h5 id="instName">Loading...</h5>
            <div class="d-flex justify-content-between mt-2">
              <span>Current Status:</span>
              <span id="statusBadge">Checking...</span>
            </div>
            <div class="d-flex justify-content-between mt-1">
              <span>Paid Until:</span>
              <strong id="paidUntilDate">-</strong>
            </div>
          </div>

          <div class="mb-3">
            <label class="text-muted small">Account Tier Calculation</label>
            <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
              <span>Active Staff Members:</span>
              <strong id="userCount">0</strong>
            </div>
          </div>

          <table class="table table-borderless">
            <tbody>
              <tr>
                <td>Annual Base Fee (<span id="tierName">Tier 1</span>)</td>
                <td class="text-end">RM <span id="basePrice">0.00</span></td>
              </tr>
              <tr id="reactivationRow" class="text-danger d-none">
                <td><i class="bi bi-exclamation-circle-fill me-1"></i>Reactivation Penalty</td>
                <td class="text-end">RM 50.00</td>
              </tr>
              <tr class="border-top">
                <td class="pt-3 fw-bold">Total Due</td>
                <td class="pt-3 text-end fw-bold fs-5">RM <span id="totalPrice">0.00</span></td>
              </tr>
            </tbody>
          </table>
          
          <div id="freeTrialMsg" class="alert alert-success d-none">
            <i class="bi bi-gift-fill me-2"></i> <strong>First Year Free!</strong> No payment required.
          </div>
        </div>
      </div>

      <div class="col-lg-5 mb-4 position-relative">
        
        <div id="paymentLock" class="d-none">
            <div class="lock-message bg-white p-4 shadow rounded border">
                <i class="bi bi-check-circle-fill text-success fs-1 mb-2"></i>
                <h5>No Payment Needed</h5>
                <p class="text-muted small mb-0">Your subscription is active. The payment window opens 1 month before expiry.</p>
            </div>
        </div>

        <div id="paymentMethods" class="bill-card h-100">
          <h5 class="mb-4">Select Payment Method</h5>
          
          <div class="d-grid gap-3">
            <button onclick="toggleQR()" class="btn btn-outline-primary py-3 text-start">
              <div class="d-flex align-items-center">
                <i class="bi bi-qr-code-scan fs-3 me-3"></i>
                <div>
                  <div class="fw-bold">DuitNow QR (Malaysia)</div>
                  <small class="text-muted">Instant transfer via Bank App</small>
                </div>
              </div>
            </button>
            
            <div id="qrSection" class="bg-light p-3 rounded text-center d-none">
                <p class="small text-muted mb-2">Scan or Transfer <strong>RM <span id="qrAmount">0.00</span></strong></p>
                <img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg" style="width:120px; opacity:0.5;" class="mb-2">
                <div class="small fw-bold">Public Bank: 1234567890</div>
                <div class="alert alert-warning mt-2 small p-2">
                    Upload receipt to Admin WhatsApp for activation.
                </div>
            </div>

            <button class="btn btn-outline-dark py-3 text-start" disabled title="Coming Soon">
              <div class="d-flex align-items-center">
                <i class="bi bi-credit-card fs-3 me-3"></i>
                <div>
                  <div class="fw-bold">Credit Card (Overseas)</div>
                  <small class="text-muted">Processed securely via Stripe</small>
                </div>
              </div>
            </button>
          </div>

          <div class="mt-4 pt-3 border-top text-center">
             <small class="text-muted">Questions? Contact Billing Support</small>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // --- FIREBASE CONFIG (Paste your config) ---
    const firebaseConfig = {
        apiKey: "AIzaSyAioaDxAEh3Cd-8Bvad9RgWXoOzozGeE_s",
        authDomain: "pallicalc-eabdc.firebaseapp.com",
        projectId: "pallicalc-eabdc",
        storageBucket: "pallicalc-eabdc.firebasestorage.app",
        messagingSenderId: "347532270864",
        appId: "1:347532270864:web:bfe5bd1b92ccec22dc5995"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- CONFIG: PRICING TIERS ---
    const TIER_PRICES = {
        1: { limit: 10, price: 100 },  // 1-10 users = RM 100
        2: { limit: 50, price: 300 },  // 11-50 users = RM 300
        3: { limit: 9999, price: 500 } // 51+ users = RM 500
    };
    const REACTIVATION_FEE = 50;

    auth.onAuthStateChanged(async (user) => {
        if (!user) return window.location.href = '../index.html';
        
        // 1. Fetch Admin & Institution Data
        const adminDoc = await db.collection('users').doc(user.uid).get();
        const adminData = adminDoc.data();
        
        // Check if MOH (Free forever)
        if (adminData.email.endsWith('.moh.gov.my') || adminData.email.endsWith('.gov.my')) {
            alert("MOH Accounts have lifetime free access.");
            window.location.href = '../admin.html';
            return;
        }

        const instId = adminData.institutionId;
        const instDoc = await db.collection('institutions').doc(instId).get();
        const instData = instDoc.data();

        // 2. Determine Stats
        const memberCount = instData.memberCount || 1; // Default to 1
        const paidUntil = adminData.subscriptionEnd ? adminData.subscriptionEnd.toDate() : new Date(); // Default to now if null
        const isFirstYear = !adminData.hasPaidOnce; // Flag in DB: if false, it's first year

        // 3. UI Updates
        document.getElementById('instName').textContent = instData.name || "My Institution";
        document.getElementById('paidUntilDate').textContent = paidUntil.toLocaleDateString('en-GB');
        document.getElementById('userCount').textContent = memberCount;

        // 4. Calculate Tier
        let basePrice = 0;
        let tierName = "Tier 1";
        
        if (memberCount <= 10) { 
            basePrice = TIER_PRICES[1].price; tierName = "Tier 1 (1-10 Staff)"; 
        } else if (memberCount <= 50) { 
            basePrice = TIER_PRICES[2].price; tierName = "Tier 2 (11-50 Staff)"; 
        } else { 
            basePrice = TIER_PRICES[3].price; tierName = "Enterprise (50+ Staff)"; 
        }

        // 5. Handle "First Year Free"
        if (isFirstYear) {
            basePrice = 0;
            document.getElementById('freeTrialMsg').classList.remove('d-none');
        }

        document.getElementById('tierName').textContent = tierName;
        document.getElementById('basePrice').textContent = basePrice.toFixed(2);

        // 6. Logic: Window & Penalties
        const now = new Date();
        
        // Calculate Windows
        const paymentWindowOpen = new Date(paidUntil);
        paymentWindowOpen.setMonth(paymentWindowOpen.getMonth() - 1); // Open 1 month before

        const gracePeriodEnd = new Date(paidUntil);
        gracePeriodEnd.setMonth(gracePeriodEnd.getMonth() + 1); // Ends 1 month after expiry (Total 13th month)

        let total = basePrice;
        let statusHtml = "";
        let lockPayment = false;

        if (now < paymentWindowOpen) {
            // A. Too Early
            statusHtml = '<span class="status-active">Active</span>';
            lockPayment = true; 
        } else if (now >= paymentWindowOpen && now <= gracePeriodEnd) {
            // B. Payment Window (Month 11 to Month 13)
            statusHtml = '<span class="status-due">Renewal Due</span>';
            // No penalty yet
        } else {
            // C. Suspended (Past Month 13)
            statusHtml = '<span class="status-suspended">Suspended</span>';
            // Add Penalty
            document.getElementById('reactivationRow').classList.remove('d-none');
            total += REACTIVATION_FEE;
        }

        document.getElementById('statusBadge').innerHTML = statusHtml;
        document.getElementById('totalPrice').textContent = total.toFixed(2);
        document.getElementById('qrAmount').textContent = total.toFixed(2);

        // 7. Lock/Unlock Interface
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('billingContent').classList.remove('d-none');

        if (lockPayment) {
            document.getElementById('paymentMethods').classList.add('blur-overlay');
            document.getElementById('paymentLock').classList.remove('d-none');
        }
    });

    function toggleQR() {
        const qr = document.getElementById('qrSection');
        qr.classList.toggle('d-none');
    }
  </script>
</body>
</html>
