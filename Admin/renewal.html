<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Renewal | PalliCalc</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Inter', sans-serif; color: #333; }
        .renewal-card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .premium-option { border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; transition: all 0.3s; background: white; cursor: pointer; }
        .premium-option:hover { border-color: #adb5bd; }
        .premium-option.selected { border-color: #198754; background-color: #f0fff4; box-shadow: 0 0 0 1px #198754; }
        .date-badge { background: #e2e3e5; color: #383d41; padding: 6px 12px; border-radius: 6px; font-weight: bold; font-size: 0.85rem; }
        .date-badge.active { background: #d1e7dd; color: #0f5132; }
        .date-badge.expired { background: #f8d7da; color: #842029; }

        .doc-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-small-outline {
            flex: 1; 
            padding: 10px; 
            border: 1px solid #cbd5e1; 
            background: white; 
            border-radius: 8px; 
            cursor: pointer; 
            color: #475569; 
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn-small-outline:hover { 
            border-color: #0ea5e9; 
            color: #0ea5e9; 
            background: #f0f9ff;
        }
        .print-warning {
            background: #fff8e1; 
            border: 1px solid #ffecb3; 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            font-size: 0.85rem; 
            color: #856404;
        }

        /* --- FIX FOR CLICK CONFLICT --- */
        /* This prevents the checkbox itself from capturing clicks, letting the parent div handle it */
        .pointer-events-none { 
            pointer-events: none; 
        }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark"><i class="bi bi-arrow-repeat text-primary me-2"></i>Renewal</h3>
                <a href="../admin.html" class="btn btn-outline-secondary btn-sm"><i class="bi bi-house"></i> Dashboard</a>
            </div>

            <div id="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted small fw-bold">Calculating staff tiers & discounts...</p>
            </div>

            <div id="renewalContent" class="d-none animate__animated animate__fadeIn">
                
                <div class="card renewal-card mb-4">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-md-7">
                                <h5 class="fw-bold mb-1" id="instName">Loading...</h5>
                                <div class="d-flex gap-2 mt-2">
                                    <span class="badge bg-primary">Tier <span id="tierNum">1</span></span>
                                    <span class="badge bg-light text-dark border"><i class="bi bi-people"></i> <span id="staffCountLabel">0</span> Staff</span>
                                </div>
                            </div>
                            <div class="col-md-5 text-md-end mt-3 mt-md-0">
                                <small class="text-muted d-block fw-bold text-uppercase" style="font-size: 0.7rem;">Current Expiry</small>
                                <div id="currentExpiryBadge" class="date-badge mt-1">Checking...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card renewal-card mb-4">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h6 class="fw-bold mb-0 text-primary">Extend Subscription (1 Year)</h6>
                    </div>
                    <div class="card-body p-4">
                        
                        <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
                            <div>
                                <h6 class="fw-bold mb-0">Base Admin License</h6>
                                <small class="text-muted">Tiered rate based on current staff count.</small>
                            </div>
                            <div class="fw-bold fs-5">
                                <span class="currencySymbol"></span> <span id="basePriceDisplay">0</span>
                            </div>
                        </div>

                        <div class="premium-option d-flex align-items-start" id="premiumBox" onclick="togglePremium()">
                            <div class="form-check mt-1 pointer-events-none">
                                <input class="form-check-input" type="checkbox" id="premiumToggle">
                            </div>
                            <div class="ms-3 flex-grow-1">
                                <label class="form-check-label fw-bold d-block">
                                    Include Premium Data Bridge
                                </label>
                                <small class="text-muted">
                                    Keep or Enable QR Transfer & Custom Headers for the next year.
                                </small>
                            </div>
                            <div class="fw-bold text-success">
                                + <span class="currencySymbol"></span> <span id="premiumPriceDisplay">0</span>
                            </div>
                        </div>

                        <div id="discountRow" class="d-none mt-3 p-2 rounded bg-light border border-success d-flex justify-content-between align-items-center text-success">
                            <span class="fw-bold small"><i class="bi bi-tag-fill me-1"></i> Discount Applied</span>
                            <span class="fw-bold">- <span id="discountDisplay">0</span>%</span>
                        </div>

                        <div class="mt-4 p-3 bg-light rounded border text-center">
                            <small class="text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">New Expiry Date After Payment</small>
                            <h5 class="fw-bold text-dark mt-1" id="previewNewDate">...</h5>
                            
                            <hr class="my-3">
                            
                            <div class="d-flex justify-content-between align-items-center px-2">
                                <span class="fw-bold text-secondary">Total Renewal Due:</span>
                                <h2 class="fw-bold text-primary mb-0"><span class="currencySymbol"></span> <span id="totalDisplay">0.00</span></h2>
                            </div>
                        </div>

                        <button id="proceedBtn" class="btn btn-primary w-100 mt-3 py-2 fw-bold" onclick="showPaymentSection()">
                            Confirm & Proceed to Payment
                        </button>

                    </div>
                </div>

                <div class="card renewal-card" id="paymentSection" style="display:none;">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3">Trust Payment Verification</h5>
                        
                        <div class="print-warning">
                            <i class="bi bi-exclamation-triangle-fill"></i> <strong>Important:</strong> Please print your Invoice or Receipt <strong>now</strong>. Automatic generation is not available after leaving this page.
                        </div>

                        <div class="doc-buttons">
                            <button type="button" class="btn-small-outline" onclick="generateInvoice()"><i class="bi bi-file-text"></i> Invoice</button>
                            <button type="button" class="btn-small-outline" onclick="generateInstantReceipt()"><i class="bi bi-printer"></i> Receipt</button>
                        </div>

                        <div class="alert alert-warning border-0 small d-flex align-items-center">
                            <i class="bi bi-shield-lock-fill fs-4 me-3"></i>
                            <div>
                                <strong>Instant Extension:</strong> Submit your payment reference below. Your subscription will be extended immediately while we verify in the background.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Payment Reference / Receipt No.</label>
                            <input type="text" id="paymentRef" class="form-control form-control-lg" placeholder="e.g. DuitNow Ref 123456">
                            <div class="form-text text-success fw-bold small mt-1" id="zeroPayMsg" style="display:none;">
                                <i class="bi bi-check-circle"></i> Total is 0. Please enter "WAIVER" or "PROMO" above.
                            </div>
                        </div>

                        <div style="margin-bottom: 20px; padding-top:10px; border-top:1px dashed #cbd5e1;">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="requestEInvoice">
                                <label class="form-check-label small text-secondary" for="requestEInvoice">
                                    Request Official LHDN e-Invoice (Sent in 30 days)
                                </label>
                            </div>
                            <p style="font-size: 0.7rem; color: #94a3b8; margin-top: 4px; padding-left: 24px; margin-bottom: 0;">
                                If you forgot to tick this, email <strong>support@pallicalc.com</strong>. <br>Response may take up to 60 days.
                            </p>
                        </div>

                        <button id="btnSubmit" class="btn btn-success w-100 py-3 fw-bold shadow-sm">
                            <i class="bi bi-check-circle-fill me-2"></i> Submit & Extend Instantly
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // --- FIREBASE INIT ---
    const firebaseConfig = {
        apiKey: "AIzaSyAioaDxAEh3Cd-8Bvad9RgWXoOzozGeE_s",
        authDomain: "pallicalc-eabdc.firebaseapp.com",
        projectId: "pallicalc-eabdc"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- CONFIG & STATE ---
    let LIVE_RENEWAL_PRICES = {
        malaysia: { tier1: 200, tier2: 500, tier3: 1000, premium_annual: 500 },
        international: { tier1: 200, tier2: 500, tier3: 1000, premium_annual: 500 }
    };

    let state = {
        basePrice: 0,
        premiumPrice: 0,
        currentExpiry: new Date(),
        newExpiry: new Date(),
        currency: 'RM',
        manualDiscount: 0 
    };

    // --- FETCH PRICES ---
    async function fetchLivePrices() {
        try {
            const doc = await db.collection('setting').doc('renewal').get();
            if (doc.exists) LIVE_RENEWAL_PRICES = doc.data();
        } catch(e) { console.error("Price fetch error:", e); }
    }

    // --- MAIN INIT ---
    auth.onAuthStateChanged(async user => {
        if (!user) return window.location.href = '../index.html';

        try {
            const userDocPromise = db.collection('users').doc(user.uid).get();
            const pricesPromise = fetchLivePrices();
            const [userDoc] = await Promise.all([userDocPromise, pricesPromise]);
            const userData = userDoc.data();

            if (userData.isMoH) {
                alert("MOH Accounts have lifetime access.");
                window.location.href = '../admin.html';
                return;
            }

            // Staff Count
            const staffSnap = await db.collection('users').where('institutionId', '==', userData.institutionId || 'none').get();
            const count = staffSnap.size || 1;

            // Region & Currency
            const isMY = (userData.country === 'Malaysia');
            state.currency = isMY ? 'RM' : 'USD';
            const geo = isMY ? 'malaysia' : 'international';
            const prices = LIVE_RENEWAL_PRICES[geo] || LIVE_RENEWAL_PRICES['international'];
            
            // Base Price Logic
            if (count <= 10) state.basePrice = prices.tier1;
            else if (count <= 50) state.basePrice = prices.tier2;
            else state.basePrice = prices.tier3;

            state.premiumPrice = prices.premium_annual;
            state.manualDiscount = userData.manualDiscount || 0;
            
            // Expiry Date Logic
            if (userData.subscriptionEnd) state.currentExpiry = userData.subscriptionEnd.toDate();
            else state.currentExpiry = new Date();

            // Populate UI
            document.querySelectorAll('.currencySymbol').forEach(el => el.textContent = state.currency);
            document.getElementById('instName').textContent = (userData.username || "User") + "'s Institution";
            document.getElementById('staffCountLabel').textContent = count;
            document.getElementById('tierNum').textContent = (count > 50) ? 3 : (count > 10 ? 2 : 1);
            document.getElementById('basePriceDisplay').textContent = state.basePrice;
            document.getElementById('premiumPriceDisplay').textContent = state.premiumPrice;

            if (state.manualDiscount > 0) {
                document.getElementById('discountRow').classList.remove('d-none');
                document.getElementById('discountDisplay').textContent = state.manualDiscount;
            }

            // Update Badge
            const now = new Date();
            const badge = document.getElementById('currentExpiryBadge');
            badge.textContent = state.currentExpiry.toLocaleDateString('en-GB');
            if (state.currentExpiry > now) {
                badge.classList.add('active');
                badge.innerHTML += ' <span class="ms-1">(Active)</span>';
            } else {
                badge.classList.add('expired');
                badge.innerHTML += ' <span class="ms-1">(Expired)</span>';
            }

            document.getElementById('premiumToggle').checked = userData.isPremium;

            calculateTotals(); 
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('renewalContent').classList.remove('d-none');

        } catch (e) {
            alert("Error loading data: " + e.message);
        }
    });

    // --- LOGIC ---
    function togglePremium() {
        const chk = document.getElementById('premiumToggle');
        chk.checked = !chk.checked;
        calculateTotals();
    }

    function calculateTotals() {
        const wantsPremium = document.getElementById('premiumToggle').checked;
        let subtotal = state.basePrice + (wantsPremium ? state.premiumPrice : 0);
        
        let discountAmt = 0;
        if (state.manualDiscount > 0) {
            discountAmt = subtotal * (state.manualDiscount / 100);
        }
        let total = subtotal - discountAmt;
        if (total < 0) total = 0;

        document.getElementById('totalDisplay').textContent = total.toFixed(2);
        
        const msg = document.getElementById('zeroPayMsg');
        if (total === 0) msg.style.display = 'block';
        else msg.style.display = 'none';

        const box = document.getElementById('premiumBox');
        if (wantsPremium) box.classList.add('selected');
        else box.classList.remove('selected');

        const now = new Date();
        let baseDate = (state.currentExpiry > now) ? state.currentExpiry : now;
        let nextDate = new Date(baseDate.getTime());
        nextDate.setFullYear(nextDate.getFullYear() + 1);
        state.newExpiry = nextDate;

        document.getElementById('previewNewDate').textContent = nextDate.toLocaleDateString('en-GB');
    }

    function showPaymentSection() {
        document.getElementById('proceedBtn').style.display = 'none';
        document.getElementById('paymentSection').style.display = 'block';
        document.getElementById('paymentSection').scrollIntoView({ behavior: 'smooth' });
    }

    // --- SUBMIT LOGIC (SIMPLIFIED) ---
    document.getElementById('btnSubmit').addEventListener('click', async () => {
        const ref = document.getElementById('paymentRef').value.trim();
        const wantsPremium = document.getElementById('premiumToggle').checked;
        const requestEInvoice = document.getElementById('requestEInvoice').checked;
        const total = parseFloat(document.getElementById('totalDisplay').textContent);
        
        if (total > 0 && !ref) return alert("Please enter your payment reference number.");
        if (total === 0 && !ref) return alert("Please enter 'WAIVER' or 'PROMO' in the reference box.");

        if(!confirm("Confirm Renewal? Access will be extended immediately.")) return;

        const btn = document.getElementById('btnSubmit');
        btn.disabled = true;
        btn.innerText = "Processing...";

        try {
            const uid = auth.currentUser.uid;

            // Simplified Update: Only lastRenewalDate and isPremium are strictly enforced
            await db.collection('users').doc(uid).update({
                subscriptionEnd: firebase.firestore.Timestamp.fromDate(state.newExpiry),
                isPremium: wantsPremium, // Directly set based on user choice
                billingStatus: 'active',
                trustStatus: 'pending-verification', 
                paymentReference: ref, 
                requestEInvoice: requestEInvoice,
                lastRenewalDate: firebase.firestore.FieldValue.serverTimestamp(),
                renewalAmount: total
            });

            // Hide Forms & Show Success Message IN-PLACE
            document.getElementById('paymentSection').style.display = 'none';
            document.querySelector('.renewal-card:nth-child(2)').style.display = 'none'; // Hide Price Card
            
            const container = document.getElementById('renewalContent');
            const successDiv = document.createElement('div');
            successDiv.className = 'text-center py-5 animate__animated animate__fadeIn';
            successDiv.innerHTML = `
                <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                <h3 class="fw-bold mt-3">Renewal Successful!</h3>
                <p class="text-muted">Your subscription has been extended to ${state.newExpiry.toLocaleDateString('en-GB')}.</p>
                <div class="alert alert-info small text-start mx-auto" style="max-width: 400px;">
                    <strong>Note:</strong> Verification is pending. Immediate access granted via Trust System.
                </div>
                <a href="../admin.html" class="btn btn-primary mt-3 px-4">Back to Dashboard</a>
            `;
            container.appendChild(successDiv);

        } catch (e) {
            alert("Error: " + e.message);
            btn.disabled = false;
            btn.innerText = "Submit & Extend Instantly";
        }
    });

    // --- DOC GENERATORS ---
    window.generateInvoice = function() {
        let desc = "Annual Renewal: Base Admin License";
        if(document.getElementById('premiumToggle').checked) desc += " + Premium Data Bridge";
        printDoc("PRO-FORMA INVOICE", "DuitNow / Stripe", "Payment Pending. Please attach proof of payment to this document.", desc);
    };

    window.generateInstantReceipt = function() {
        const ref = document.getElementById('paymentRef').value || "PENDING";
        printDoc("INSTANT RECEIPT", `Payment Ref: ${ref}`, "Keep this as your pro-forma proof of transaction.", "Annual Subscription Renewal");
    };

    function printDoc(title, payInfo, note, description) {
        const amt = document.getElementById('totalDisplay').textContent;
        const curr = state.currency;
        const instName = document.getElementById('instName').textContent;
        
        const win = window.open('', '_blank');
        win.document.write(`
            <html><head><title>${title}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body{padding:40px;font-family:sans-serif}
                .header{border-bottom:2px solid #0ea5e9;margin-bottom:30px}
                .verification-notice{border: 2px solid #dc3545; padding: 15px; border-radius: 8px; margin-top: 20px; color: #b91c1c; font-size: 0.9rem;}
            </style>
            </head><body onload="window.print()">
            <div class="header d-flex justify-content-between">
                <div><h2 style="color:#0ea5e9">PalliCalc</h2><small>Alivioscript Solutions</small></div>
                <div class="text-end"><h4>${title}</h4><p>${new Date().toLocaleDateString()}</p></div>
            </div>
            <div class="p-4 bg-light rounded mb-4">
                <strong>Bill To:</strong> ${instName}<br>
                <strong>Payable To:</strong> Alivioscript Solutions<br>
                <strong>Method:</strong> ${payInfo}
            </div>
            <table class="table table-bordered">
                <tr><th>Description</th><th class="text-end">Amount</th></tr>
                <tr><td>${description}</td><td class="text-end fw-bold">${curr} ${amt}</td></tr>
            </table>
            <div class="verification-notice">
                <strong>STATUS: PENDING VERIFICATION</strong><br>
                Note: ${note}<br><br>
                <em>PalliCalc operates on a trust system. Immediate extension is granted; however, accounts will be suspended if payment verification fails.</em>
            </div>
            <p class="text-center text-muted mt-5 small">For support, contact support@pallicalc.com<br>Alison Chai, RPh: 9093</p>

        `);
        win.document.close();
    }
</script>
<script src="/js/ga-tracking.js"></script>
</body>
</html>