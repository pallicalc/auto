<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opioid & Morfin | Panduan Pesakit</title>
    
    <link rel="stylesheet" href="../education.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="/js/qr.min.js"></script>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    // SAFETY: Prevent crash if Analytics is blocked
    window.trackEvent = window.trackEvent || function() {};
</script>
</head>
<body>

    <div id="pdf-loading">
        <div style="text-align:center">
            <div style="display:inline-block; width: 3rem; height: 3rem; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 15px; font-weight: bold;">Menyediakan PDF...</p>
        </div>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    </div>

    <div class="main-container">
        
<div class="header header-pain">
        <div id="inst-header-container" class="inst-header-container">
            <img id="inst-logo-img" class="inst-logo" src="" alt="Logo" style="display:none;">
            <div class="inst-info">
                <h3 id="inst-name-display"></h3>
                <p id="inst-contact-display"></p>
            </div>
        </div>
        <h1><i class="bi bi-capsule-pill" style="margin-right: 8px;"></i> Opioid & Morfin</h1>
        <p>Panduan anda untuk kelegaan kesakitan dan penjagaan keselesaan</p>
    </div>
        <div class="nav-bar">
            <a href="../index.html" class="nav-link">
                <i class="bi bi-arrow-left"></i> Kembali
            </a>
            <div class="nav-link" onclick="showQR(); trackEvent('share_content', { method: 'QR', type: 'Education' })">
                <i class="bi bi-share-fill"></i> Kongsi
            </div>
        </div>

        <div class="section">
            <h2><i class="bi bi-capsule-pill" style="color:#1565c0"></i> Apakah itu Opioid?</h2>
            <p>Opioid digunakan untuk mengawal kesakitan, sesak nafas, dan batuk. Ia terdapat dalam pelbagai bentuk seperti cecair, tablet, pelekat, dan suntikan.</p>
            <br>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 12px; border-left: 4px solid #1565c0;">
                <strong>Opioid Biasa:</strong> Codeine, Tramadol, Morfin, Fentanyl, dan Oxycodone.
                <br><br>
                <em>Morfin dianggap sebagai 'standard emas' dalam merawat sakit kanser.</em>
            </div>
            <p style="margin-top: 15px; font-size: 14px;">Morfin mula bertindak dengan cepat, mencapai kesan maksimum selepas <strong>1 jam</strong> (oral), dan kesannya bertahan kira-kira <strong>4 jam</strong>.</p>
        </div>

        <div class="section">
            <h2><i class="bi bi-shield-check" style="color:#c0392b"></i> Ketakutan Biasa</h2>
            <p>Ramai pesakit bimbang tentang pengambilan ubat penahan sakit yang kuat. Berikut adalah faktanya:</p>

            <div class="fear-grid">
                <div class="fear-card" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #333;">
                    <strong>MITOS: Adakah opioid mempercepatkan kematian?</strong>
                    <p style="margin-top: 8px;"><strong>FAKTA:</strong> Tidak. Jika digunakan dengan betul, ia tidak memendekkan hayat. Kajian menunjukkan pesakit sering hidup lebih lama kerana keselesaan yang optimum.</p>
                </div>

                <div class="fear-card" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color: #333;">
                    <strong>MITOS: Adakah saya akan ketagih?</strong>
                    <p style="margin-top: 8px;"><strong>FAKTA:</strong> Tidak. Opioid yang digunakan mengikut arahan doktor untuk melegakan kesakitan tidak akan menyebabkan ketagihan.</p>
                </div>

                <div class="fear-card" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); color: #333;">
                    <strong>MITOS: Adakah kesannya akan hilang?</strong>
                    <p style="margin-top: 8px;"><strong>FAKTA:</strong> Kesan penahan sakit tidak hilang. Dos yang betul adalah dos yang dapat melegakan sakit. Tiada had maksimum dos.</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2><i class="bi bi-clipboard-pulse" style="color:#e67e22"></i> Kesan Sampingan</h2>
            <p>Kebanyakan kesan sampingan adalah sementara atau boleh dirawat.</p>

            <div class="side-effects-grid"> 
                <div class="side-effect">
                    <strong>1. Sembelit</strong>
                    <p>Sangat biasa. Opioid biasanya diberikan bersama ubat pelawas untuk mencegah perkara ini.</p>
                </div>

                <div class="side-effect">
                    <strong>2. Loya & Muntah</strong>
                    <p>Biasanya sementara. Ambil ubat selepas makan untuk membantu mengurangkan rasa loya.</p>
                </div>

                <div class="side-effect">
                    <strong>3. Mengantuk</strong>
                    <p>Biasa berlaku pada permulaan. Jangan memandu atau mengendalikan jentera berat.</p>
                </div>

                <div class="side-effect">
                    <strong>4. Mulut Kering</strong>
                    <p>Minum air sedikit demi sedikit, hisap ketulan ais, atau gula-gula masam.</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2><i class="bi bi-check-circle" style="color:#27ae60;"></i> Cara Pengambilan</h2>
            <div class="rules-grid">
                <div class="rule-card">
                    <div class="rule-number">1</div>
                    <div class="rule-content">
                        <strong>Ikut Dos</strong>
                        <p>Jangan melebihi dos yang ditetapkan atau menggandakan dos jika terlepas.</p>
                    </div>
                </div>
                <div class="rule-card">
                    <div class="rule-number">2</div>
                    <div class="rule-content">
                        <strong>Sakit Tiba-tiba (Breakthrough)</strong>
                        <p>Anda boleh mengambil dos tambahan jika sakit menyerang. Tunggu sekurang-kurangnya <strong>1 jam</strong> dari dos terakhir.</p>
                    </div>
                </div>
                <div class="rule-card">
                    <div class="rule-number">3</div>
                    <div class="rule-content">
                        <strong>Rekodkan</strong>
                        <p>Catat berapa banyak dos tambahan yang diambil dan maklumkan kepada doktor anda.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-pdf" onclick="printPDF()">
                <i class="bi bi-printer-fill"></i> Cetak PDF
            </button>
        </div>

    </div>

    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeQR()">&times;</span>
            <h3>Imbas untuk Kongsi</h3>
            <div id="qrcode-wrapper-safe">
                <div id="qrcode"></div>
            </div>
            <p style="margin-top:10px; color:#666">Imbas untuk lihat di telefon</p>
        </div>
    </div>

    <script src="../education.js"></script>

    <script>
        async function printPDF() {
            const loading = document.getElementById('pdf-loading');
            loading.style.display = 'flex';
            
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert("Sila benarkan 'popups' untuk melihat PDF.");
                loading.style.display = 'none';
                return;
            }
            printWindow.document.write('Sila tunggu, sedang menjana PDF...');

            try {
                // A. GET DATA
                let footerData = { name: "PalliCalc Patient Education", contact: "", logos: [] };
                if (window.context && window.context.instId) {
                    const cached = localStorage.getItem('cached_inst_' + window.context.instId);
                    if (cached) {
                        const d = JSON.parse(cached);
                        footerData = { 
                            name: d.headerName || d.name, 
                            contact: d.headerContact || d.contact, 
                            logos: d.headerLogos || (d.logo ? [d.logo] : [])
                        };
                    }
                } else {
                    const s = localStorage.getItem('institutionSettings');
                    if (s) {
                        const parsed = JSON.parse(s);
                        footerData = { name: parsed.name, contact: parsed.contact, logos: parsed.logos || [parsed.logo] };
                    }
                }

                // B. LOAD PDF (Changing target to 'bm.pdf')
                const { PDFDocument, rgb, StandardFonts } = PDFLib;
                
                // IMPORTANT: Ensure 'bm.pdf' exists in the opioid/ folder!
                const existingPdfBytes = await fetch('bm.pdf').then(res => {
                    if (!res.ok) throw new Error("Fail bm.pdf tidak dijumpai!");
                    return res.arrayBuffer();
                });

                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const newPdf = await PDFDocument.create();
                
                const helveticaFont = await newPdf.embedFont(StandardFonts.Helvetica);
                const helveticaBold = await newPdf.embedFont(StandardFonts.HelveticaBold);
                const embeddedPages = await newPdf.embedPdf(pdfDoc);

                const A4_W = 595.28; 
                const A4_H = 841.89;
                const FOOTER_H = 80;

                // C. STAMP FOOTER (Matches English Layout)
                for (const page of embeddedPages) {
                    const newPage = newPdf.addPage([A4_W, A4_H]);
                    
                    // 1. Content
                    const scale = Math.min(A4_W / page.width, (A4_H - FOOTER_H) / page.height);
                    const w = page.width * scale;
                    const h = page.height * scale;
                    newPage.drawPage(page, { x: (A4_W - w)/2, y: FOOTER_H, width: w, height: h });

                    // 2. Line
                    const lineY = FOOTER_H - 10;
                    newPage.drawLine({ 
                        start: {x: 30, y: lineY}, 
                        end: {x: A4_W-30, y: lineY}, 
                        thickness: 0.5, 
                        color: rgb(0.6, 0.6, 0.6) 
                    });

                    // 3. LOGOS (LEFT)
                    let currentX = 30;
                    if (footerData.logos && footerData.logos.length > 0) {
                        for (const logoUrl of footerData.logos) {
                            try {
                                if (!logoUrl) continue;
                                const logoBytes = await fetch(logoUrl).then(res => res.arrayBuffer());
                                let logoImg;
                                if (logoUrl.toLowerCase().includes('png')) logoImg = await newPdf.embedPng(logoBytes);
                                else logoImg = await newPdf.embedJpg(logoBytes);

                                const lScale = 35 / logoImg.height;
                                const lWidth = logoImg.width * lScale;
                                
                                newPage.drawImage(logoImg, {
                                    x: currentX,
                                    y: lineY - 45,
                                    width: lWidth,
                                    height: 35
                                });
                                currentX += lWidth + 15;
                            } catch (e) { console.warn("Ralat Logo", e); }
                        }
                    }

                    // 4. TEXT (RIGHT)
                    const nameStr = footerData.name || "PalliCalc Patient Education";
                    const contactStr = footerData.contact ? `Hubungi: ${footerData.contact}` : "";
                    
                    const nameWidth = helveticaBold.widthOfTextAtSize(nameStr, 12);
                    newPage.drawText(nameStr, { 
                        x: A4_W - 30 - nameWidth, 
                        y: lineY - 25, 
                        size: 12, 
                        font: helveticaBold, 
                        color: rgb(0.2, 0.2, 0.2) 
                    });

                    if (contactStr) {
                        const contactWidth = helveticaFont.widthOfTextAtSize(contactStr, 10);
                        newPage.drawText(contactStr, { 
                            x: A4_W - 30 - contactWidth, 
                            y: lineY - 40, 
                            size: 10, 
                            font: helveticaFont, 
                            color: rgb(0.4, 0.4, 0.4) 
                        });
                    }

                    // 5. COPYRIGHT (CENTER)
                    const copyText = "© 2026 Alivioscript Solutions | PalliCalc™";
                    const copyWidth = helveticaFont.widthOfTextAtSize(copyText, 8);
                    newPage.drawText(copyText, {
                        x: (A4_W - copyWidth) / 2,
                        y: 10,
                        size: 8,
                        font: helveticaFont,
                        color: rgb(0.6, 0.6, 0.6)
                    });
                }

                const pdfBytes = await newPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                printWindow.location.href = URL.createObjectURL(blob);

            } catch (e) {
                printWindow.close();
                alert("Ralat: " + e.message);
            } finally {
                loading.style.display = 'none';
            }
        }
    </script>
<script src="/js/ga-tracking.js"></script>
</body>
</html>