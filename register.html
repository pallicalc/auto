<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Create Account | PalliCalc Trust</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="style.css">

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <style>
    /* UI POLISH */
    .premium-card { background: #f0f7ff; border: 2px solid #cfe2ff; transition: all 0.3s ease; }
    .premium-card:hover { border-color: #9ec5fe; }
    
    .role-card { cursor: pointer; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; transition: 0.2s; position: relative; overflow: hidden; }
    .role-card:hover { border-color: #adb5bd; }
    .role-card.selected { border-color: #0d6efd; background-color: #f8fbff; box-shadow: 0 0 0 1px #0d6efd; }
    .role-card.selected::after { content: "\F26E"; font-family: "bootstrap-icons"; position: absolute; top: 10px; right: 10px; color: #0d6efd; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
  </style>
</head>
<body class="auth-body bg-light">

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">
      
      <div class="card shadow-sm border-0 rounded-4 p-4">
        <div class="text-center mb-4">
          <h2 class="fw-bold text-primary">Join PalliCalc</h2>
          <p class="text-muted small">Clinical Calculators are free. Admin Tools require verification.</p>
        </div>

        <form id="register-form">
          
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label small fw-bold">Display Name</label>
              <input id="username" type="text" class="form-control" required placeholder="e.g. Dr. Ali">
            </div>
            <div class="col-md-6">
              <label class="form-label small fw-bold">Occupation</label>
              <select id="occupation" class="form-select" required>
                <option value="">Select...</option>
                <option value="Medical Officer">Medical Officer</option>
                <option value="Specialist">Specialist</option>
                <option value="Pharmacist">Pharmacist</option>
                <option value="Nurse">Nurse</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label small fw-bold">Professional Email</label>
            <input id="email" type="email" class="form-control" required placeholder="name@hospital.com">
          </div>

          <div class="mb-3">
            <label class="form-label small fw-bold">Country / Region</label>
            <select id="country" class="form-select" required>
              <option value="">Select Location...</option>
              <option value="Malaysia">Malaysia</option>
              <option value="Singapore">Singapore</option>
              <option value="United Kingdom">United Kingdom</option>
              <option value="Australia">Australia</option>
              <option value="Other">Other</option>
            </select>
            <div class="form-text x-small">Determines billing currency (RM vs USD).</div>
          </div>

          <div class="mb-4">
            <label class="form-label small fw-bold">Account Role</label>
            <div class="d-grid gap-2">
              
              <label class="role-card d-flex align-items-center">
                <input type="radio" name="role" value="personal" class="form-check-input d-none" checked>
                <div class="ms-2">
                  <div class="fw-bold"><i class="bi bi-person me-2"></i>Personal User</div>
                  <div class="small text-muted">Individual calculators. <span id="personalPriceLabel">Free</span>.</div>
                </div>
              </label>
              
              <label class="role-card d-flex align-items-center">
                <input type="radio" name="role" value="institutionAdmin" class="form-check-input d-none">
                <div class="ms-2">
                  <div class="fw-bold"><i class="bi bi-building-gear me-2"></i>Institution Admin</div>
                  <div class="small text-muted">Manage a ward team & data transfer.</div>
                </div>
              </label>
            </div>
          </div>

          <div id="premiumOptionSection" class="d-none animate__animated animate__fadeIn">
            
            <div class="premium-card p-4 rounded-3 mb-4">
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="wantsPremium" style="transform: scale(1.3);">
                <label class="form-check-label fw-bold ms-2 text-primary" for="wantsPremium">
                  Enable Premium Data Bridge
                </label>
              </div>

              <div class="bg-white p-3 rounded-3 mb-3 border shadow-sm">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="fw-bold small text-uppercase text-muted mb-0">Premium Features:</h6>
                  <button type="button" class="btn btn-link btn-sm text-decoration-none p-0 fw-bold" onclick="showPreview()">
                    <i class="bi bi-eye"></i> Preview
                  </button>
                </div>
                <ul class="list-unstyled mb-0 small text-secondary">
                  <li class="mb-1"><i class="bi bi-check-circle-fill text-success me-2"></i>QR Code Data Transfer</li>
                  <li class="mb-1"><i class="bi bi-check-circle-fill text-success me-2"></i>Auto-Sync to Google Sheets</li>
                  <li class="mb-1"><i class="bi bi-check-circle-fill text-success me-2"></i>Custom Ward Headers on PDF</li>
                </ul>
                
                <div class="mt-3 pt-2 border-top d-flex gap-2">
                  <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" onclick="generateInvoice()">
                    <i class="bi bi-file-text"></i> Invoice
                  </button>
                  <button type="button" class="btn btn-outline-primary btn-sm flex-fill" onclick="generateInstantReceipt()">
                    <i class="bi bi-printer"></i> Receipt
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div id="paymentInputSection" class="d-none mb-4">
             <div class="card bg-light border-0 p-3">
                <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                    <div>
                        <small class="text-uppercase fw-bold text-muted" style="font-size:0.7rem">Total Due</small>
                        <div class="small text-muted" id="paymentFrequency">One-Time</div>
                    </div>
                    <h3 class="fw-bold text-primary mb-0"><span id="currencySymbol">RM</span> <span id="totalDisplay">0</span></h3>
                </div>

                <label class="form-label small fw-bold">Payment Reference / Receipt No.</label>
                <input id="paymentRef" type="text" class="form-control" placeholder="Paste DuitNow / Stripe Ref">
                <div class="form-text text-success x-small fw-bold mb-3">
                    <i class="bi bi-lightning-charge-fill"></i> Instant access granted upon submission.
                </div>

                <div class="form-check bg-white p-2 rounded border">
                    <input class="form-check-input ms-1" type="checkbox" id="requestEInvoice">
                    <label class="form-check-label x-small fw-bold ms-2" for="requestEInvoice">
                        Request Official LHDN e-Invoice
                    </label>
                    <div class="x-small text-muted ms-4 ps-1" style="font-size: 0.7rem;">
                        Official tax invoice sent via email within 30 days.
                    </div>
                </div>
             </div>
          </div>

          <div class="row g-2 mb-3">
             <div class="col-md-6">
                 <label class="form-label small fw-bold">Password</label>
                 <input id="password" type="password" class="form-control" required placeholder="Min 6 chars">
             </div>
             <div class="col-md-6">
                 <label class="form-label small fw-bold">Promo / Beta Code</label>
                 <input id="promo-code" type="text" class="form-control" placeholder="Optional">
             </div>
          </div>

          <button type="submit" id="submit-btn" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">
            <i class="bi bi-shield-check me-2"></i> Verify & Create Account
          </button>
          
          <div id="error-msg" class="alert alert-danger mt-3 small d-none"></div>

          <div class="text-center mt-4">
            <a href="index.html" class="small text-decoration-none">Already have an account? Login</a>
          </div>

        </form>
      </div>
      
      <div class="text-center mt-4 text-muted small">
        &copy; 2026 Alivioscript Solutions.<br>Trust-Based Verification System.
      </div>

    </div>
  </div>
</div>

<div id="previewModal" class="modal-overlay">
    <div class="bg-white p-4 rounded-4 shadow-lg text-center position-relative" style="width: 90%; max-width: 400px;">
        <button onclick="document.getElementById('previewModal').style.display='none'" class="btn-close position-absolute top-0 end-0 m-3"></button>
        <h5 class="fw-bold mb-3">Premium Data Bridge</h5>
        
        <div class="bg-light border border-dashed rounded p-4 mb-3">
            
            <i class="bi bi-qr-code-scan display-1 text-primary"></i>
            <p class="mt-3 fw-bold text-dark">Scan &rarr; Sync</p>
            <p class="small text-muted mb-0">Patient scans the code on your phone. Their IPOS scores appear instantly in your department's Google Sheet.</p>
        </div>
        
        <button class="btn btn-secondary w-100 btn-sm" onclick="document.getElementById('previewModal').style.display='none'">Close Preview</button>
    </div>
</div>

<script>
    // --- FIREBASE INIT ---
    const firebaseConfig = {
        apiKey: "AIzaSyAioaDxAEh3Cd-8Bvad9RgWXoOzozGeE_s",
        authDomain: "pallicalc-eabdc.firebaseapp.com",
        projectId: "pallicalc-eabdc"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ==========================================
    // 1. MASTER PRICE CONTROL CENTER
    // ==========================================
    const PALLICALC_PRICES = {
        personal: { 
            registration: 0  // <--- Change to 50 when you are ready to charge personal users
        },
        moh: { 
            registration_basic: 0, 
            premium_upgrade_one_time: 500 
        },
        private: { 
            reg_fixed_fee: 500,
            premium_fixed_fee: 500
        }
    };

    // ==========================================
    // 2. PRICING LOGIC ENGINE
    // ==========================================
    function updatePricing() {
        const country = document.getElementById('country').value;
        const email = document.getElementById('email').value.trim().toLowerCase();
        const role = document.querySelector('input[name="role"]:checked').value;
        const wantsPremium = document.getElementById('wantsPremium').checked;
        
        const isMoH = email.endsWith('@moh.gov.my');
        const isMalaysia = (country === 'Malaysia');
        
        const adminSection = document.getElementById('premiumOptionSection');
        const paySection = document.getElementById('paymentInputSection');
        const freqLabel = document.getElementById('paymentFrequency');
        const totalDisplay = document.getElementById('totalDisplay');

        // Currency
        const currency = isMalaysia ? 'RM' : 'USD';
        document.getElementById('currencySymbol').textContent = currency;

        let total = 0;

        // --- Logic Branching ---
        if (role === 'personal') {
            // Hide Admin Perks
            adminSection.classList.add('d-none');
            
            // Check Personal Fee
            total = PALLICALC_PRICES.personal.registration;
            freqLabel.textContent = "One-time Account Activation";
            
            // Update Label on the Card itself
            document.getElementById('personalPriceLabel').textContent = total > 0 ? `${currency} ${total}` : "Free";
        } 
        else if (role === 'institutionAdmin') {
            // Show Admin Perks
            adminSection.classList.remove('d-none');

            if (isMoH) {
                // MOH Rule
                total = wantsPremium ? PALLICALC_PRICES.moh.premium_upgrade_one_time : 0;
                freqLabel.textContent = "Lifetime Activation (MOH Special)";
            } else {
                // Private Rule
                const regFee = PALLICALC_PRICES.private.reg_fixed_fee;
                const premFee = wantsPremium ? PALLICALC_PRICES.private.premium_fixed_fee : 0;
                total = regFee + premFee;
                
                freqLabel.textContent = wantsPremium ? "Registration + Premium Bridge" : "Registration Fee Only";
            }
        }

        // --- Update UI ---
        totalDisplay.textContent = total;

        // Only show Payment Inputs if money is involved
        if (total > 0) {
            paySection.classList.remove('d-none');
        } else {
            paySection.classList.add('d-none');
        }
    }

    // Event Listeners
    document.querySelectorAll('input[name="role"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            // Highlight styling
            document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
            e.target.closest('.role-card').classList.add('selected');
            updatePricing();
        });
    });
    
    ['country', 'email', 'wantsPremium'].forEach(id => {
        document.getElementById(id).addEventListener('change', updatePricing);
        if(id === 'email') document.getElementById(id).addEventListener('input', updatePricing);
    });

    // ==========================================
    // 3. SUBMIT & TRUST LOGIC
    // ==========================================
    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        const errorEl = document.getElementById('error-msg');
        
        errorEl.classList.add('d-none');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

        const email = document.getElementById('email').value.trim().toLowerCase();
        const password = document.getElementById('password').value;
        const ref = document.getElementById('paymentRef').value.trim();
        const total = parseInt(document.getElementById('totalDisplay').textContent);
        const role = document.querySelector('input[name="role"]:checked').value;
        
        try {
            // A. UNIQUE REFERENCE CHECK (If paying)
            if (total > 0) {
                if (!ref) throw new Error("Please enter your Payment Reference Number.");
                const dupeCheck = await db.collection('users').where('paymentReference', '==', ref).get();
                if (!dupeCheck.empty) throw new Error("This Reference Number is already in use.");
            }

            // B. CREATE USER
            const cred = await auth.createUserWithEmailAndPassword(email, password);
            const uid = cred.user.uid;

            // C. DETERMINE FLAGS
            const isMoH = email.endsWith('@moh.gov.my');
            const promo = document.getElementById('promo-code').value.trim().toUpperCase();
            const wantsPremium = document.getElementById('wantsPremium').checked;
            
            // Premium Logic:
            // 1. If MOH + Beta Code -> Free Premium
            // 2. If Paid Total > 0 + Ticked Box -> Paid Premium
            let isPremiumActive = false;
            let manualDiscount = 0;

            if (isMoH && promo === 'BETAMOH2026') {
                manualDiscount = 100;
                isPremiumActive = true;
            } else if (role === 'institutionAdmin' && wantsPremium && (total > 0 || isMoH)) {
                isPremiumActive = true;
            }

            // D. SAVE TO FIRESTORE
            await db.collection('users').doc(uid).set({
                username: document.getElementById('username').value,
                email: email,
                role: role,
                occupation: document.getElementById('occupation').value,
                country: document.getElementById('country').value,
                isMoH: isMoH,
                
                // TRUST SYSTEM FIELDS
                isPremium: isPremiumActive,
                billingStatus: 'active', // INSTANT ACCESS
                trustStatus: total > 0 ? 'pending-verification' : 'verified',
                paymentReference: ref || "N/A",
                requestEInvoice: document.getElementById('requestEInvoice').checked,
                
                // BILLING META
                promoCode: promo,
                manualDiscount: manualDiscount,
                subscriptionEnd: (!isMoH && role === 'institutionAdmin') ? 
                    new Date(new Date().setFullYear(new Date().getFullYear() + 1)) : null,
                
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // E. CREATE INSTITUTION (If Admin)
            if (role === 'institutionAdmin') {
                const instId = email.split('@')[0] + '-' + Date.now().toString().slice(-6);
                await db.collection('institutions').doc(instId).set({
                    adminUid: uid,
                    name: "My Palliative Unit",
                    country: document.getElementById('country').value
                });
                await db.collection('users').doc(uid).update({ institutionId: instId });
            }

            alert("Account Created Successfully! \nYou have been granted INSTANT ACCESS.");
            window.location.href = "index.html";

        } catch (err) {
            console.error(err);
            errorEl.textContent = err.message;
            errorEl.classList.remove('d-none');
            btn.disabled = false;
            btn.textContent = "Verify & Create Account";
        }
    });

    // ==========================================
    // 4. DOCUMENT GENERATORS (Stateless)
    // ==========================================
    function showPreview() { document.getElementById('previewModal').style.display = 'flex'; }

    function generateInvoice() {
        printDoc("PRO-FORMA INVOICE", "DuitNow / Stripe Transfer", "Please include a copy of this invoice with your payment proof.");
    }
    
    function generateInstantReceipt() {
        const ref = document.getElementById('paymentRef').value || "PENDING";
        printDoc("INSTANT RECEIPT", `Payment Ref: ${ref}`, "This is a pro-forma receipt based on your trust reference.");
    }

    function printDoc(title, payInfo, note) {
        const amt = document.getElementById('totalDisplay').textContent;
        const curr = document.getElementById('currencySymbol').textContent;
        const date = new Date().toLocaleDateString();
        
        const win = window.open('', '_blank');
        win.document.write(`
            <html><head><title>${title}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>body{padding:40px;font-family:sans-serif}.header{border-bottom:2px solid #0d6efd;margin-bottom:30px}</style>
            </head><body onload="window.print()">
            <div class="header d-flex justify-content-between">
                <div><h2 class="text-primary fw-bold">PalliCalc</h2><small>Alivioscript Solutions</small></div>
                <div class="text-end"><h4>${title}</h4><p>${date}</p></div>
            </div>
            <div class="p-4 bg-light rounded mb-4">
                <strong>Payable To:</strong> Alivioscript Solutions (Reg: Pending)<br>
                <strong>Method:</strong> ${payInfo}
            </div>
            <table class="table table-bordered">
                <tr><td><strong>Service Activation Fee</strong><br><small class="text-muted">Digital Access & Admin Tools</small></td><td class="text-end fw-bold">${curr} ${amt}</td></tr>
            </table>
            <p class="text-center text-muted mt-5 small">${note}<br>Alison Chai, RPh: 9093</p>
            </body></html>
        `);
        win.document.close();
    }
</script>
</body>
</html>